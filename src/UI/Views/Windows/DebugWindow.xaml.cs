using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using SunEyeVision.Plugin.Infrastructure;
using SunEyeVision.Plugin.SDK;
using SunEyeVision.Plugin.SDK.Core;
using SunEyeVision.Plugin.SDK.Metadata;
using SunEyeVision.UI.Diagnostics;
using SunEyeVision.UI.Factories;

namespace SunEyeVision.UI.Views.Windows
{
    /// <summary>
    /// DebugWindow.xaml çš„äº¤äº’é€»è¾‘ - æ”¯æŒè‡ªå®šä¹‰æ§ä»¶å’Œè‡ªåŠ¨ç”Ÿæˆæ§ä»¶çš„æ··åˆæ¨¡å¼
    /// </summary>
    public partial class DebugWindow : Window, INotifyPropertyChanged, IDebugControlProvider
    {
        public event PropertyChangedEventHandler? PropertyChanged;

        private string _toolName = "";
        private string _toolType = "";
        private string _toolStatus = "å°±ç»ª";
        private string _statusMessage = "ç­‰å¾…æ‰§è¡Œ...";
        private string _executionTime = "0 ms";
        private string _fps = "0.0";
        private IToolPlugin? _toolPlugin;
        private ToolMetadata? _toolMetadata;
        private bool _useCustomControl = false;

        public string ToolName
        {
            get => _toolName;
            set
            {
                if (_toolName != value)
                {
                    _toolName = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(ToolName)));
                }
            }
        }

        public string ToolType
        {
            get => _toolType;
            set
            {
                if (_toolType != value)
                {
                    _toolType = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(ToolType)));
                }
            }
        }

        public string ToolStatus
        {
            get => _toolStatus;
            set
            {
                if (_toolStatus != value)
                {
                    _toolStatus = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(ToolStatus)));
                }
            }
        }

        public string StatusMessage
        {
            get => _statusMessage;
            set
            {
                if (_statusMessage != value)
                {
                    _statusMessage = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(StatusMessage)));
                }
            }
        }

        public string ExecutionTime
        {
            get => _executionTime;
            set
            {
                if (_executionTime != value)
                {
                    _executionTime = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(ExecutionTime)));
                }
            }
        }

        public string FPS
        {
            get => _fps;
            set
            {
                if (_fps != value)
                {
                    _fps = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(FPS)));
                }
            }
        }

        public ObservableCollection<ToolParameter> ToolParameters { get; }

        public DebugWindow(string toolId, IToolPlugin toolPlugin, ToolMetadata toolMetadata)
        {
            InitializeComponent();
            DataContext = this;

            _toolPlugin = toolPlugin;
            _toolMetadata = toolMetadata;
            ToolName = toolMetadata.DisplayName;
            ToolType = toolId;

            ToolParameters = new ObservableCollection<ToolParameter>();
            
            InitializeDebugInterface();
        }

        /// <summary>
        /// åˆå§‹åŒ–è°ƒè¯•ç•Œé¢ - æ ¹æ®å·¥å…·é…ç½®å†³å®šä½¿ç”¨è‡ªå®šä¹‰æ§ä»¶è¿˜æ˜¯è‡ªåŠ¨ç”Ÿæˆæ§ä»¶
        /// </summary>
        private void InitializeDebugInterface()
        {
            var customControlContainer = this.FindName("customControlContainer") as System.Windows.Controls.Panel;

            if (customControlContainer != null)
            {
                // æ£€æŸ¥å·¥å…·æ˜¯å¦æä¾›è‡ªå®šä¹‰æ§ä»¶
                if (_toolPlugin is IDebugControlProvider debugProvider &&
                    debugProvider.HasCustomDebugControl(ToolType))
                {
                    var customControl = debugProvider.CreateDebugControl(ToolType);
                    if (customControl != null)
                    {
                        _useCustomControl = true;
                        customControlContainer.Children.Add(customControl);
                        StatusMessage = "ä½¿ç”¨è‡ªå®šä¹‰è°ƒè¯•æ§ä»¶";
                        return;
                    }
                }

                // ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„æ§ä»¶
                LoadAutoGeneratedControls(customControlContainer);
            }
            else
            {
                // å‘åå…¼å®¹æ¨¡å¼ - ä¿ç•™åŸæœ‰çš„ç¡¬ç¼–ç å‚æ•°åŠ è½½
                LoadDefaultParameters(ToolType);
            }
        }

        /// <summary>
        /// åŠ è½½è‡ªåŠ¨ç”Ÿæˆçš„å‚æ•°æ§ä»¶
        /// </summary>
        private void LoadAutoGeneratedControls(System.Windows.Controls.Panel container)
        {
            if (_toolMetadata?.InputParameters == null || _toolMetadata.InputParameters.Count == 0)
            {
                StatusMessage = "å·¥å…·æ²¡æœ‰é…ç½®å‚æ•°";
                return;
            }

            // æŒ‰åˆ†ç»„ç»„ç»‡å‚æ•°
            var parameterGroups = new Dictionary<string, List<ParameterMetadata>>();
            foreach (var param in _toolMetadata.InputParameters)
            {
                var category = string.IsNullOrEmpty(param.Category) ? "åŸºæœ¬å‚æ•°" : param.Category;
                if (!parameterGroups.ContainsKey(category))
                {
                    parameterGroups[category] = new List<ParameterMetadata>();
                }
                parameterGroups[category].Add(param);
            }

            // ä¸ºæ¯ä¸ªåˆ†ç»„åˆ›å»ºUI
            foreach (var group in parameterGroups)
            {
                var groupBorder = CreateParameterGroupBorder(group.Key);
                var stackPanel = groupBorder.Child as StackPanel;

                if (stackPanel != null)
                {
                    foreach (var param in group.Value)
                    {
                        var paramControl = CreateParameterControl(param);
                        stackPanel.Children.Add(paramControl);
                    }
                }

                container.Children.Add(groupBorder);
            }

            StatusMessage = $"åŠ è½½äº† {_toolMetadata.InputParameters.Count} ä¸ªå‚æ•°";
        }

        /// <summary>
        /// åˆ›å»ºå‚æ•°åˆ†ç»„è¾¹æ¡†
        /// </summary>
        private Border CreateParameterGroupBorder(string groupName)
        {
            var border = new Border
            {
                Background = new SolidColorBrush(Color.FromRgb(255, 255, 255)),
                BorderBrush = new SolidColorBrush(Color.FromRgb(224, 224, 224)),
                BorderThickness = new Thickness(1),
                CornerRadius = new CornerRadius(4),
                Margin = new Thickness(0, 0, 0, 8)
            };

            var stackPanel = new StackPanel();

            // åˆ†ç»„æ ‡é¢˜
            var headerBorder = new Border
            {
                Background = new SolidColorBrush(System.Windows.Media.Color.FromRgb(240, 248, 255)),
                Padding = new Thickness(8),
                BorderBrush = new SolidColorBrush(System.Windows.Media.Color.FromRgb(0, 102, 204)),
                BorderThickness = new Thickness(0, 0, 0, 2)
            };

            var headerText = new TextBlock
            {
                Text = $"ğŸ“‹ {groupName}",
                FontWeight = FontWeights.Bold,
                FontSize = 12,
                Foreground = new SolidColorBrush(Color.FromRgb(0, 102, 204))
            };

            headerBorder.Child = headerText;
            stackPanel.Children.Add(headerBorder);

            border.Child = stackPanel;
            return border;
        }

        /// <summary>
        /// åˆ›å»ºå•ä¸ªå‚æ•°æ§ä»¶
        /// </summary>
        private FrameworkElement CreateParameterControl(ParameterMetadata param)
        {
            var border = new Border
            {
                Padding = new Thickness(8),
                BorderBrush = new SolidColorBrush(Color.FromRgb(240, 240, 240)),
                BorderThickness = new Thickness(0, 0, 0, 1)
            };

            var grid = new Grid();
            grid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(80) });
            grid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(1, GridUnitType.Star) });

            // å‚æ•°åç§°
            var nameText = new TextBlock
            {
                Text = param.DisplayName,
                VerticalAlignment = VerticalAlignment.Center,
                FontSize = 11,
                Foreground = new SolidColorBrush(Color.FromRgb(102, 102, 102))
            };

            if (param.Required)
            {
                nameText.Text += " *";
                nameText.FontWeight = FontWeights.SemiBold;
            }

            Grid.SetColumn(nameText, 0);
            grid.Children.Add(nameText);

            // å‚æ•°æ§ä»¶
            var control = ParameterControlFactory.CreateControl(param);
            Grid.SetColumn(control, 1);
            grid.Children.Add(control);

            // å‚æ•°æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰
            if (!string.IsNullOrEmpty(param.Description))
            {
                var descText = new TextBlock
                {
                    Text = param.Description,
                    FontSize = 10,
                    Foreground = new SolidColorBrush(Color.FromRgb(153, 153, 153)),
                    TextWrapping = TextWrapping.Wrap,
                    Margin = new Thickness(80, 2, 0, 0)
                };
                grid.RowDefinitions.Add(new RowDefinition { Height = GridLength.Auto });
                grid.RowDefinitions.Add(new RowDefinition { Height = GridLength.Auto });
                Grid.SetRow(nameText, 0);
                Grid.SetRow(control, 0);
                Grid.SetRow(descText, 1);
                Grid.SetColumn(descText, 0);
                Grid.SetColumnSpan(descText, 2);
                grid.Children.Add(descText);
            }

            border.Child = grid;
            return border;
        }

        /// <summary>
        /// IDebugControlProvider å®ç°
        /// </summary>
        public object GetDebugPanel()
        {
            return this;
        }

        public void StartDebug()
        {
            // å¼€å§‹è°ƒè¯•é€»è¾‘
        }

        public void StopDebug()
        {
            // åœæ­¢è°ƒè¯•é€»è¾‘
        }

        public void Step()
        {
            // å•æ­¥æ‰§è¡Œé€»è¾‘
        }

        public void Reset()
        {
            // é‡ç½®è°ƒè¯•é€»è¾‘
        }

        public bool HasCustomDebugControl(string toolType)
        {
            // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰è°ƒè¯•æ§ä»¶
            return _toolPlugin is IDebugControlProvider;
        }

        public FrameworkElement CreateDebugControl(string toolType)
        {
            // åˆ›å»ºè‡ªå®šä¹‰è°ƒè¯•æ§ä»¶
            if (_toolPlugin is IDebugControlProvider debugProvider)
            {
                return debugProvider.CreateDebugControl(toolType);
            }
            return null;
        }

        private void LoadDefaultParameters(string toolType)
        {
            ToolParameters.Clear();

            switch (toolType)
            {
                case "GaussianBlur":
                    ToolParameters.Add(new ToolParameter { Name = "KernelSize", Value = "5" });
                    ToolParameters.Add(new ToolParameter { Name = "Sigma", Value = "1.0" });
                    break;
                case "Threshold":
                    ToolParameters.Add(new ToolParameter { Name = "Threshold", Value = "128" });
                    ToolParameters.Add(new ToolParameter { Name = "Invert", Value = "False" });
                    break;
                case "GrayScale":
                    ToolParameters.Add(new ToolParameter { Name = "Method", Value = "Average" });
                    break;
                case "EdgeDetection":
                    ToolParameters.Add(new ToolParameter { Name = "Method", Value = "Canny" });
                    ToolParameters.Add(new ToolParameter { Name = "Threshold1", Value = "50" });
                    ToolParameters.Add(new ToolParameter { Name = "Threshold2", Value = "150" });
                    break;
                case "ImageCapture":
                    ToolParameters.Add(new ToolParameter { Name = "Camera", Value = "ç›¸æœº1" });
                    ToolParameters.Add(new ToolParameter { Name = "Exposure", Value = "10000" });
                    ToolParameters.Add(new ToolParameter { Name = "Gain", Value = "10.5" });
                    break;
                case "TemplateMatching":
                    ToolParameters.Add(new ToolParameter { Name = "Template", Value = "template.png" });
                    ToolParameters.Add(new ToolParameter { Name = "Threshold", Value = "0.8" });
                    ToolParameters.Add(new ToolParameter { Name = "Method", Value = "Normalized Correlation" });
                    break;
                default:
                    ToolParameters.Add(new ToolParameter { Name = "Parameter1", Value = "" });
                    break;
            }
        }

        /// <summary>
        /// è·å–å½“å‰å‚æ•°å€¼
        /// </summary>
        public Dictionary<string, object> GetParameterValues()
        {
            var values = new Dictionary<string, object>();

            if (_useCustomControl)
            {
                // è‡ªå®šä¹‰æ§ä»¶æ¨¡å¼ - éœ€è¦è°ƒç”¨è€…ä»è‡ªå®šä¹‰æ§ä»¶è·å–å€¼
                return values;
            }

            // è‡ªåŠ¨ç”Ÿæˆæ§ä»¶æ¨¡å¼
            if (_toolMetadata?.InputParameters != null)
            {
                var container = this.FindName("customControlContainer") as System.Windows.Controls.Panel;
                if (container != null)
                {
                    foreach (var param in _toolMetadata.InputParameters)
                    {
                        var value = ExtractValueFromContainer(container, param);
                        if (value != null)
                        {
                            values[param.Name] = value;
                        }
                    }
                }
            }

            return values;
        }

        /// <summary>
        /// ä»å®¹å™¨ä¸­æå–å‚æ•°å€¼
        /// </summary>
        private object? ExtractValueFromContainer(System.Windows.Controls.Panel container, ParameterMetadata param)
        {
            foreach (var child in container.Children)
            {
                if (child is Border border && border.Child is StackPanel stackPanel)
                {
                    foreach (var spChild in stackPanel.Children)
                    {
                        if (spChild is Grid grid)
                        {
                            var control = FindParameterControl(grid);
                            if (control != null)
                            {
                                return ConvertControlValue(control, param);
                            }
                        }
                    }
                }
            }
            return param.DefaultValue;
        }

        /// <summary>
        /// åœ¨Gridä¸­æŸ¥æ‰¾å‚æ•°æ§ä»¶
        /// </summary>
        private Control? FindParameterControl(Grid grid)
        {
            foreach (var child in grid.Children)
            {
                if (child is Control control && !(child is TextBlock))
                {
                    return control;
                }
            }
            return null;
        }

        /// <summary>
        /// è½¬æ¢æ§ä»¶å€¼ä¸ºå‚æ•°ç±»å‹
        /// </summary>
        private object? ConvertControlValue(Control control, ParameterMetadata param)
        {
            try
            {
                switch (param.Type)
                {
                    case ParamDataType.Int:
                        if (control is TextBox textBox)
                        {
                            return int.TryParse(textBox.Text, out var intVal) ? intVal : (int?)null;
                        }
                        break;

                    case ParamDataType.Double:
                        if (control is TextBox textBoxDbl)
                        {
                            return double.TryParse(textBoxDbl.Text, out var dblVal) ? dblVal : (double?)null;
                        }
                        break;

                    case ParamDataType.Bool:
                        if (control is CheckBox checkBox)
                        {
                            return checkBox.IsChecked;
                        }
                        break;

                    case ParamDataType.Enum:
                        if (control is ComboBox comboBox)
                        {
                            return comboBox.SelectedItem?.ToString();
                        }
                        break;

                    case ParamDataType.String:
                        if (control is TextBox textBoxStr)
                        {
                            return textBoxStr.Text;
                        }
                        break;

                    default:
                        return null;
                }
            }
            catch
            {
                return param.DefaultValue;
            }

            return param.DefaultValue;
        }

        #region å›¾åƒæ˜¾ç¤º

        private void btnOriginal_Click(object sender, RoutedEventArgs e)
        {
            SetActiveButton(sender as Button);
            ShowPlaceholder("åŸå›¾");
        }

        private void btnProcessed_Click(object sender, RoutedEventArgs e)
        {
            SetActiveButton(sender as Button);
            ShowPlaceholder("å¤„ç†å");
        }

        private void btnResult_Click(object sender, RoutedEventArgs e)
        {
            SetActiveButton(sender as Button);
            ShowPlaceholder("æ£€æµ‹ç»“æœ");
        }

        private void SetActiveButton(Button? activeButton)
        {
            if (activeButton == null) return;

            btnOriginal.Background = activeButton == btnOriginal ? new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(255, 255, 255)) : new System.Windows.Media.SolidColorBrush(System.Windows.Media.Colors.Transparent);
            btnProcessed.Background = activeButton == btnProcessed ? new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(255, 255, 255)) : new System.Windows.Media.SolidColorBrush(System.Windows.Media.Colors.Transparent);
            btnResult.Background = activeButton == btnResult ? new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(255, 255, 255)) : new System.Windows.Media.SolidColorBrush(System.Windows.Media.Colors.Transparent);
        }

        private void ShowPlaceholder(string text)
        {
            imgDisplay.Source = null;
            txtNoImage.Text = $"æš‚æ— {text}";
            txtNoImage.Visibility = Visibility.Visible;
        }

        private void btnZoomIn_Click(object sender, RoutedEventArgs e)
        {
            StatusMessage = "æ”¾å¤§å›¾åƒ";
        }

        private void btnZoomOut_Click(object sender, RoutedEventArgs e)
        {
            StatusMessage = "ç¼©å°å›¾åƒ";
        }

        private void btnFit_Click(object sender, RoutedEventArgs e)
        {
            StatusMessage = "é€‚åº”çª—å£";
        }

        private void btn1to1_Click(object sender, RoutedEventArgs e)
        {
            StatusMessage = "1:1 æ˜¾ç¤º";
        }

        #endregion

        #region æ‰§è¡Œæ§åˆ¶

        private void btnRun_Click(object sender, RoutedEventArgs e)
        {
            ToolStatus = "è¿è¡Œä¸­";
            StatusMessage = "æ­£åœ¨æ‰§è¡Œå·¥å…·...";

            var random = new Random();
            ExecutionTime = $"{random.Next(5, 50)} ms";
            FPS = $"{random.Next(20, 60)}.{random.Next(0, 9)}";

            StatusMessage = "æ‰§è¡Œå®Œæˆ";
            ToolStatus = "å°±ç»ª";
        }

        private void btnReset_Click(object sender, RoutedEventArgs e)
        {
            if (_useCustomControl)
            {
                StatusMessage = "è‡ªå®šä¹‰æ§ä»¶æ¨¡å¼ï¼Œè¯·é‡ç½®è‡ªå®šä¹‰æ§ä»¶";
            }
            else
            {
                LoadDefaultParameters(ToolType);
                StatusMessage = "å‚æ•°å·²é‡ç½®";
            }
            ToolStatus = "å°±ç»ª";
        }

        #endregion
    }

    /// <summary>
    /// å·¥å…·å‚æ•°æ¨¡å‹
    /// </summary>
    public class ToolParameter : INotifyPropertyChanged
    {
        private string _name = "";
        private string _value = "";

        public event PropertyChangedEventHandler? PropertyChanged;

        public string Name
        {
            get => _name;
            set
            {
                if (_name != value)
                {
                    _name = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(Name)));
                }
            }
        }

        public string Value
        {
            get => _value;
            set
            {
                if (_value != value)
                {
                    _value = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(Value)));
                }
            }
        }
    }
}
