┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              核心模块详解                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                     1. Plugin.Abstractions (SDK层)                           │  │
│   ├─────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                             │  │
│   │   职责: 定义系统核心契约，作为插件开发的标准接口                              │  │
│   │                                                                             │  │
│   │   核心接口:                                                                 │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ IImageProcessor                                                     │  │  │
│   │   │ ├── ProcessAsync(Mat input, AlgorithmParameters params)            │  │  │
│   │   │ ├── Name { get; }                                                   │  │  │
│   │   │ └── Description { get; }                                            │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ IToolPlugin                                                         │  │  │
│   │   │ ├── Metadata { get; }        // 工具元数据                          │  │  │
│   │   │ ├── CreateViewModel()        // 创建视图模型                        │  │  │
│   │   │ ├── CreateView()            // 创建视图                             │  │  │
│   │   │ └── CreateProcessor()       // 创建处理器                           │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ AlgorithmParameters          算法参数基类                            │  │  │
│   │   │ AlgorithmResult              算法结果基类                            │  │  │
│   │   │ ToolMetadata                 工具元数据                              │  │  │
│   │   │ ParameterMetadata            参数元数据                              │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │                                                                             │  │
│   │   设计特点: ✅ 零依赖 ✅ 纯契约 ✅ 可独立打包                               │  │
│   │                                                                             │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                          2. Core (领域层)                                    │  │
│   ├─────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                             │  │
│   │   职责: 实现核心业务逻辑，提供基础服务                                       │  │
│   │                                                                             │  │
│   │   子模块:                                                                   │  │
│   │   ┌────────────────┬────────────────────────────────────────────────────┐  │  │
│   │   │    目录        │                    内容                            │  │  │
│   │   ├────────────────┼────────────────────────────────────────────────────┤  │  │
│   │   │ Interfaces/    │ ILogger, IConfigManager, IDeviceManager           │  │  │
│   │   │ Services/      │ ConsoleLogger, FileLogger, OptimizedLogger        │  │  │
│   │   │                │ LogManager, JsonConfigManager, PluginManager       │  │  │
│   │   │ IO/            │ IFileAccessManager, FileAccessManager             │  │  │
│   │   │                │ FileAccessScope, FileAccessServiceRegistration     │  │  │
│   │   │ Models/        │ DeviceInfo, Mat, NodeType                         │  │  │
│   │   │ Enums/         │ LogLevel                                          │  │  │
│   │   └────────────────┴────────────────────────────────────────────────────┘  │  │
│   │                                                                             │  │
│   │   关键特性:                                                                 │  │
│   │   • 依赖反转: Core → Plugin.Abstractions                                   │  │
│   │   • 文件生命周期管理 (引用计数 + 延迟删除)                                  │  │
│   │   • 可扩展日志系统 (多输出目标)                                             │  │
│   │                                                                             │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                       3. Workflow (应用层)                                   │  │
│   ├─────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                             │  │
│   │   职责: 工作流定义、执行控制、节点管理                                       │  │
│   │                                                                             │  │
│   │   核心组件:                                                                 │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ WorkflowEngine                  工作流引擎                          │  │  │
│   │   │ ├── LoadWorkflow()              加载工作流                          │  │  │
│   │   │ ├── ValidateWorkflow()          验证工作流                          │  │  │
│   │   │ └── ExecuteSync()              同步执行                            │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ WorkflowExecutionEngine         执行引擎 (异步控制)                  │  │  │
│   │   │ ├── ExecuteAsync()             异步执行                            │  │  │
│   │   │ ├── PauseAsync()               暂停                                │  │  │
│   │   │ ├── ResumeAsync()              恢复                                │  │  │
│   │   │ ├── StopAsync()                停止                                │  │  │
│   │   │ └── StepAsync()                单步执行                            │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ WorkflowContext                 执行上下文                          │  │  │
│   │   │ ├── Variables                  全局变量                            │  │  │
│   │   │ ├── CallStack                  调用栈                              │  │  │
│   │   │ ├── NodeStates                 节点状态                            │  │  │
│   │   │ ├── Logs                       执行日志                            │  │  │
│   │   │ └── CancellationToken          取消令牌                            │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │                                                                             │  │
│   │   节点类型:                                                                 │  │
│   │   ┌────────────────┬────────────────────────────────────────────────────┐  │  │
│   │   │ WorkflowNode   │ 节点基类 - 定义输入输出端口                        │  │  │
│   │   │ AlgorithmNode  │ 算法节点 - 调用图像处理算法                        │  │  │
│   │   │ SubroutineNode │ 子程序节点 - 支持循环/参数映射                     │  │  │
│   │   │ ConditionNode  │ 条件节点 - 分支判断                               │  │  │
│   │   └────────────────┴────────────────────────────────────────────────────┘  │  │
│   │                                                                             │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                         4. UI (表现层)                                       │  │
│   ├─────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                             │  │
│   │   职责: 用户交互、数据展示、界面渲染                                         │  │
│   │                                                                             │  │
│   │   MVVM 架构:                                                                │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ View (视图)                    ViewModel (视图模型)                  │  │  │
│   │   │ ┌─────────────────────────┐    ┌─────────────────────────────────┐  │  │  │
│   │   │ │ MainWindow.xaml         │ ←→ │ MainWindowViewModel             │  │  │  │
│   │   │ │ ToolboxControl.xaml     │ ←→ │ ToolboxViewModel                │  │  │  │
│   │   │ │ DiagramCanvas.xaml      │ ←→ │ WorkflowViewModel               │  │  │  │
│   │   │ │ PropertyPanel.xaml      │ ←→ │ PropertyPanelViewModel          │  │  │  │
│   │   │ └─────────────────────────┘    └─────────────────────────────────┘  │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │                                                                             │  │
│   │   核心控件:                                                                 │  │
│   │   ┌────────────────┬────────────────────────────────────────────────────┐  │  │
│   │   │ DiagramCanvas  │ 流程图画布 - 节点拖放、连接线绘制                  │  │  │
│   │   │ ToolboxControl │ 工具箱 - 工具节点列表                              │  │  │
│   │   │ PropertyPanel  │ 属性面板 - 节点参数编辑                            │  │  │
│   │   │ ImagePreview   │ 图像预览 - GPU加速渲染                            │  │  │
│   │   └────────────────┴────────────────────────────────────────────────────┘  │  │
│   │                                                                             │  │
│   │   GPU加速渲染:                                                              │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ DirectXThumbnailRenderer   DirectX缩略图渲染                        │  │  │
│   │   │ DirectXGpuThumbnailLoader  GPU批量加载                               │  │  │
│   │   │ ExifThumbnailExtractor     EXIF缩略图提取                            │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │                                                                             │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                   5. Plugin.Infrastructure (基础设施层)                      │  │
│   ├─────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                             │  │
│   │   职责: 插件加载、管理、注册                                                 │  │
│   │                                                                             │  │
│   │   核心组件:                                                                 │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ PluginLoader                  插件加载器                            │  │  │
│   │   │ ├── LoadFromDirectory()       从目录加载                            │  │  │
│   │   │ ├── LoadFromAssembly()        从程序集加载                          │  │  │
│   │   │ └── ValidatePlugin()          验证插件                              │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ PluginManager                 插件管理器                            │  │  │
│   │   │ ├── RegisterPlugin()          注册插件                              │  │  │
│   │   │ ├── UnregisterPlugin()        注销插件                              │  │  │
│   │   │ ├── GetPlugin()               获取插件                              │  │  │
│   │   │ └── GetAllPlugins()           获取所有插件                          │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │  │
│   │   │ ToolRegistry                  工具注册表                            │  │  │
│   │   │ ├── RegisterTool()            注册工具                              │  │  │
│   │   │ ├── GetTool()                 获取工具                              │  │  │
│   │   │ └── GetAllTools()             获取所有工具                          │  │  │
│   │   └─────────────────────────────────────────────────────────────────────┘  │  │
│   │                                                                             │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
