# 路径避让优化测试指南

## 优化概述

本次实施了一个完整的节点避让优化方案，解决路径穿过目标节点的问题。优化包含6个核心模块：

### 已实施的模块

#### ✅ 模块1：安全距离常量定义
- `NodeSafeDistance = 25.0` - 节点安全距离
- `PathClearanceDistance = 15.0` - 路径净空距离

#### ✅ 模块2：精确的碰撞检测系统
- 快速排除：线段和矩形边界框的快速检查
- 多采样点检测：25%、50%、75%三个采样点
- 线段相交检测：完整线段与矩形边的相交检测

#### ✅ 模块3：统一的节点避让后处理
- `ApplyNodeAvoidance()` - 主避让方法（最多迭代5次）
- `FindCollisionSegment()` - 查找碰撞线段
- `CalculateAvoidancePoints()` - 计算避让拐点
- `CalculateTwoPointAvoidance()` - 双点避让
- `InsertAvoidancePoints()` - 插入避让拐点

#### ✅ 模块4：第一个拐点计算优化
- `CalculateFirstPoint()` 统一使用`NodeSafeDistance`

#### ✅ 模块5：各策略集成统一避让
- 所有策略共享统一的避让系统
- 移除了各策略内部的避让逻辑

#### ✅ 模块6：调试日志系统
- 详细的调试日志，便于追踪路径计算过程

## 避让优先级说明

**第一优先级：让最后一段路径从正确方向接近目标端口**

- **Bottom端口**：从**上方**接近，最后一段路径**向下**到达端口
- **Top端口**：从**下方**接近，最后一段路径**向上**到达端口
- **Right端口**：从**左方**接近，最后一段路径**向右**到达端口
- **Left端口**：从**右方**接近，最后一段路径**向左**到达端口

这样确保箭头能以正确的方向进入目标端口。

## 测试场景

### 场景1：水平相邻节点连接（最常见场景）
**配置**：
- 左边节点：右端口（Right）
- 右边节点：左端口（Left）
- 距离：中等（100-300px）

**预期结果**：
- 使用相对方向策略（OppositeDirection）或HorizontalFirst
- 路径不穿过任何中间节点
- 如果有中间节点，应该从上方或下方避让

**测试步骤**：
1. 创建3个水平排列的节点
2. 连接左边节点和右边节点
3. 观察路径是否正确避让中间节点

### 场景2：垂直相邻节点连接
**配置**：
- 上方节点：下端口（Bottom）
- 下方节点：上端口（Top）
- 距离：中等（100-300px）

**预期结果**：
- 使用相对方向策略（OppositeDirection）或VerticalFirst
- 路径不穿过任何中间节点
- 如果有中间节点，应该从左侧或右侧避让

**测试步骤**：
1. 创建3个垂直排列的节点
2. 连接上方节点和下方节点
3. 观察路径是否正确避让中间节点

### 场景3：同向端口连接（水平）
**配置**：
- 两个节点都在左侧，都有右端口（Right）
- 垂直距离：中等（50-200px）
- 水平距离：近（50-100px）

**预期结果**：
- 使用三段式（ThreeSegment）或四段式（FourSegment）策略
- 路径可能先向右延伸，然后向下/上，再向左回到目标
- 不穿过任何节点

**测试步骤**：
1. 创建两个垂直排列的节点
2. 设置两个节点的端口都在右侧
3. 连接这两个节点
4. 观察路径形状和避让效果

### 场景4：同向端口连接（垂直）
**配置**：
- 两个节点都在上方，都有下端口（Bottom）
- 水平距离：中等（50-200px）
- 垂直距离：近（50-100px）

**预期结果**：
- 使用三段式（ThreeSegment）或四段式（FourSegment）策略
- 路径可能先向下延伸，然后向左/右，再向上回到目标
- 不穿过任何节点

**测试步骤**：
1. 创建两个水平排列的节点
2. 设置两个节点的端口都在底部
3. 连接这两个节点
4. 观察路径形状和避让效果

### 场景5：复杂多节点场景
**配置**：
- 创建5-6个节点，形成复杂的节点布局
- 创建多个连接，形成复杂的连线网络

**预期结果**：
- 所有路径都不穿过任何节点
- 路径形状合理，避免过度曲折
- 避让优先级正确（从正确方向接近目标端口）

**测试步骤**：
1. 创建复杂的节点布局
2. 创建多个连接
3. 逐一检查每条路径是否正确避让
4. 观察路径是否美观、合理

### 场景6：极近距离连接
**配置**：
- 两个节点距离很近（< 50px）
- 各种端口方向组合

**预期结果**：
- 使用Direct策略直接连接
- 路径最短，无不必要的拐点

**测试步骤**：
1. 创建两个距离很近的节点
2. 使用各种端口方向组合进行连接
3. 观察路径是否选择最短路径

### 场景7：长距离连接
**配置**：
- 两个节点距离很远（> 500px）
- 中间有多个其他节点

**预期结果**：
- 使用复杂的路径策略（四段式或五段式）
- 路径正确避让所有中间节点
- 路径不过于曲折

**测试步骤**：
1. 创建两个距离很远的节点
2. 在中间放置多个节点
3. 连接远端的两个节点
4. 观察路径是否正确避让所有中间节点

## 调试日志说明

优化后的系统会输出详细的调试日志，帮助你理解路径计算过程：

### 关键日志标签

- `[OrthogonalPath]` - 路径计算主流程
- `[ApplyNodeAvoidance]` - 节点避让后处理
- `[CalculateAvoidancePoints]` - 避让拐点计算
- `[CalculateFirstPoint]` - 第一个拐点计算
- `[Priority1]`、`[Priority2]`、`[Priority3]`、`[Priority4]` - 策略选择优先级

### 如何查看调试日志

在Visual Studio中运行项目时，调试日志会输出到"输出"窗口（View → Output）。

## 预期改进效果

优化后应该观察到以下改进：

1. **不再穿过目标节点** - 路径应该完全避开所有节点
2. **更合理的避让方向** - 最后一段路径从正确方向接近目标端口
3. **更平滑的路径** - 减少不必要的拐点
4. **更好的视觉效果** - 路径形状更美观、更直观
5. **更智能的避让** - 能够处理复杂的节点布局

## 已知限制

1. **性能考虑** - 避让后处理增加了迭代检测，可能影响性能（最多5次迭代）
2. **极端情况** - 在极度拥挤的节点布局中，可能仍无法找到完全无碰撞的路径
3. **路径美观度** - 优先考虑避让而非美观，某些情况下路径可能不够优雅

## 回滚方案

如果优化后出现问题，可以回滚到之前的版本：

```bash
git checkout HEAD~1 -- SunEyeVision.UI/Services/PathCalculators/OrthogonalPathCalculator.cs
git checkout HEAD~1 -- SunEyeVision.UI/Services/PathCalculators/IPathCalculator.cs
git checkout HEAD~1 -- SunEyeVision.UI/Services/ConnectionPathCache.cs
git checkout HEAD~1 -- SunEyeVision.UI/Controls/WorkflowCanvasControl.xaml.cs
```

## 后续优化建议

1. **性能优化** - 如果避让后处理影响性能，可以添加缓存机制
2. **路径平滑** - 考虑使用贝塞尔曲线替代直角折线，使路径更平滑
3. **批量避让** - 优化多连接场景下的避让算法，避免路径交叉
4. **动态安全距离** - 根据节点密度动态调整安全距离
5. **路径评分系统** - 引入路径质量评分，选择最优的避让方案

## 测试检查清单

- [ ] 场景1：水平相邻节点连接 - 通过/失败
- [ ] 场景2：垂直相邻节点连接 - 通过/失败
- [ ] 场景3：同向端口连接（水平） - 通过/失败
- [ ] 场景4：同向端口连接（垂直） - 通过/失败
- [ ] 场景5：复杂多节点场景 - 通过/失败
- [ ] 场景6：极近距离连接 - 通过/失败
- [ ] 场景7：长距离连接 - 通过/失败
- [ ] 调试日志正常输出 - 通过/失败
- [ ] 无性能明显下降 - 通过/失败
- [ ] 视觉效果改善 - 通过/失败

## 问题反馈

如果在测试过程中发现问题，请记录：

1. 问题描述
2. 测试场景配置
3. 实际行为
4. 预期行为
5. 调试日志截图
6. 节点布局截图

这些信息将有助于进一步优化路径计算系统。
