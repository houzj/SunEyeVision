# SunEyeVision 项目架构实施指南

## 实施概述

本文档记录了SunEyeVision项目框架-插件架构的实施过程和已完成的工作。

## 一、已实施内容

### 1.1 核心接口层（SunEyeVision.Core）

已创建以下核心接口文件：

#### 1. IPlugin.cs
- 位置：`SunEyeVision.Core/Interfaces/Plugins/IPlugin.cs`
- 功能：定义所有插件的基础接口
- 成员：
  - PluginId, PluginName, Version, Description, Author（属性）
  - Initialize(), Start(), Stop(), Cleanup()（生命周期方法）

#### 2. IPluginUIProvider.cs
- 位置：`SunEyeVision.Core/Interfaces/Plugins/IPluginUIProvider.cs`
- 功能：定义插件UI提供者接口（可选）
- 成员：
  - Mode（UI提供模式：Auto/Hybrid/Custom）
  - GetCustomControl()（获取自定义控件）
  - GetCustomPanel()（获取自定义面板）

#### 3. INodePlugin.cs
- 位置：`SunEyeVision.Core/Interfaces/Plugins/INodePlugin.cs`
- 功能：定义工作流节点插件接口
- 成员：
  - NodeType, Icon, Category（节点属性）
  - InputPorts, OutputPorts（端口定义）
  - GetParameters()（参数元数据）
  - Execute()（执行节点逻辑）

#### 4. IAlgorithmPlugin.cs
- 位置：`SunEyeVision.Core/Interfaces/Plugins/IAlgorithmPlugin.cs`
- 功能：定义算法插件接口
- 成员：
  - AlgorithmType, Icon, Category（算法属性）
  - GetParameters()（参数元数据）
  - Execute()（执行算法）
  - ValidateParameters()（参数验证）

### 1.2 UI框架层（SunEyeVision.UI）

已创建以下UI核心组件：

#### 1. 核心服务
- **PluginUIAdapter.cs**
  - 位置：`SunEyeVision.UI/Core/Services/PluginUIAdapter.cs`
  - 功能：智能选择UI展示方式
  - 方法：
    - GetMainControl() - 获取主界面控件
    - GetAdditionalPanel() - 获取附加面板
    - GetMode() - 获取UI模式
    - NeedsPropertyPanel() - 判断是否需要属性面板

#### 2. 共享UI组件库
- **GenericPropertyGrid**
  - 位置：`SunEyeVision.UI/Shared/Controls/PropertyGrid/`
  - 功能：通用属性网格，支持多种数据类型
  - 支持：int, double, bool, string，以及带Options的下拉选择

- **GenericParameterPanel**
  - 位置：`SunEyeVision.UI/Shared/Controls/ParameterPanel/`
  - 功能：通用参数面板，显示运行时参数

- **ImageVisualizationPanel**
  - 位置：`SunEyeVision.UI/Shared/Controls/Visualization/`
  - 功能：图像可视化面板，显示图像处理结果

- **ProgressPanel**
  - 位置：`SunEyeVision.UI/Shared/Controls/Common/`
  - 功能：进度面板，显示任务执行进度

- **StatusIndicator**
  - 位置：`SunEyeVision.UI/Shared/Controls/Common/`
  - 功能：状态指示器，显示运行状态

#### 3. 插件调试系统
- **IDebugControlProvider**
  - 位置：`SunEyeVision.UI/PluginDebug/IDebugControlProvider.cs`
  - 功能：调试控制提供者接口

- **DebugControlManager**
  - 位置：`SunEyeVision.UI/PluginDebug/DebugControlManager.cs`
  - 功能：管理所有插件的调试控制器

- **SharedDebugControl**
  - 位置：`SunEyeVision.UI/PluginDebug/SharedDebugControl.xaml`
  - 功能：共享调试控件，提供通用的调试功能

#### 4. 面板扩展系统
- **IPanelExtension**
  - 位置：`SunEyeVision.UI/Panel/PanelExtension.cs`
  - 功能：面板扩展接口

- **PanelManager**
  - 位置：`SunEyeVision.UI/Panel/PanelManager.cs`
  - 功能：单例模式，管理所有扩展面板

### 1.3 核心服务（SunEyeVision.Core）

#### PluginManager
- 位置：`SunEyeVision.Core/Services/PluginManager.cs`
- 功能：
  - 从指定目录批量加载插件
  - 注册插件并加载元数据
  - 管理插件生命周期（Start/Stop/Cleanup）
  - 提供插件查询和管理API

### 1.4 示例插件

已创建三个示例插件，分别演示三种UI模式：

#### 1. ImageProcessingPlugin（Auto模式）
- 位置：`Plugins/ImageProcessing/`
- 特点：
  - 零代码UI，框架自动生成
  - 实现IAlgorithmPlugin接口
  - 未实现IPluginUIProvider（自动使用Auto模式）
  - 包含完整的参数元数据定义

#### 2. WorkflowPlugin（Hybrid模式）
- 位置：`Plugins/Workflow/`
- 特点：
  - 使用框架通用控件
  - 添加自定义面板（使用ProgressPanel和StatusIndicator）
  - 实现INodePlugin和IPluginUIProvider接口
  - Mode设置为Hybrid

#### 3. CustomFiltersPlugin（Custom模式）
- 位置：`Plugins/CustomFilters/`
- 特点：
  - 完全自定义UI界面
  - 实现IAlgorithmPlugin和IPluginUIProvider接口
  - Mode设置为Custom
  - 包含CustomFilterControl和CustomFilterSettingsPanel两个自定义控件

### 1.5 应用程序初始化

#### App.xaml.cs
- 修改位置：`SunEyeVision.UI/App.xaml.cs`
- 更新内容：
  - 添加PluginManager引用
  - 在OnStartup中初始化插件管理器
  - 从Plugins目录加载所有插件

## 二、目录结构

### 2.1 框架层结构

```
SunEyeVision.Core/
├── Interfaces/
│   └── Plugins/                     # 插件接口定义
│       ├── IPlugin.cs               # ✓ 已创建
│       ├── IPluginUIProvider.cs     # ✓ 已创建
│       ├── INodePlugin.cs           # ✓ 已创建
│       └── IAlgorithmPlugin.cs      # ✓ 已创建
├── Services/
│   └── PluginManager.cs             # ✓ 已创建
└── SunEyeVision.Core.csproj         # ✓ 已更新（添加System.Text.Json）
```

### 2.2 UI框架层结构

```
SunEyeVision.UI/
├── Core/
│   └── Services/
│       └── PluginUIAdapter.cs       # ✓ 已创建
├── Shared/                          # 共享UI组件库
│   └── Controls/
│       ├── PropertyGrid/            # ✓ 已创建
│       │   ├── GenericPropertyGrid.xaml
│       │   ├── GenericPropertyGrid.xaml.cs
│       │   └── PropertyItemPanel.cs
│       ├── ParameterPanel/          # ✓ 已创建
│       │   ├── GenericParameterPanel.xaml
│       │   └── GenericParameterPanel.xaml.cs
│       ├── Visualization/           # ✓ 已创建
│       │   ├── ImageVisualizationPanel.xaml
│       │   └── ImageVisualizationPanel.xaml.cs
│       └── Common/                  # ✓ 已创建
│           ├── ProgressPanel.xaml
│           ├── ProgressPanel.xaml.cs
│           ├── StatusIndicator.xaml
│           └── StatusIndicator.xaml.cs
├── PluginDebug/                     # ✓ 已创建
│   ├── IDebugControlProvider.cs
│   ├── DebugControlManager.cs
│   ├── SharedDebugControl.xaml
│   └── SharedDebugControl.xaml.cs
├── Panel/                           # ✓ 已创建
│   ├── PanelExtension.cs
│   └── PanelManager.cs
└── App.xaml.cs                      # ✓ 已更新
```

### 2.3 插件层结构

```
Plugins/
├── ImageProcessing/                  # ✓ 已创建（Auto模式示例）
│   ├── plugin.json
│   ├── SunEyeVision.Plugins.ImageProcessing.csproj
│   └── ImageProcessingPlugin.cs
├── Workflow/                         # ✓ 已创建（Hybrid模式示例）
│   ├── plugin.json
│   ├── SunEyeVision.Plugins.Workflow.csproj
│   └── WorkflowPlugin.cs
└── CustomFilters/                   # ✓ 已创建（Custom模式示例）
    ├── plugin.json
    ├── SunEyeVision.Plugins.CustomFilters.csproj
    └── CustomFiltersPlugin.cs
```

## 三、架构特点

### 3.1 框架-插件分离

- **框架层**：提供核心功能、接口定义、共享UI组件
- **插件层**：实现具体业务逻辑，通过接口与框架通信
- **优势**：高度解耦，独立开发，易于扩展

### 3.2 三种UI模式

#### Auto模式
- **特点**：零代码UI，框架自动生成
- **适用**：简单算法、快速原型
- **实现**：不实现IPluginUIProvider

#### Hybrid模式
- **特点**：使用框架通用控件 + 自定义面板
- **适用**：需要部分自定义的插件
- **实现**：实现IPluginUIProvider，Mode=Hybrid

#### Custom模式
- **特点**：完全自定义UI
- **适用**：复杂交互、特殊UI需求
- **实现**：实现IPluginUIProvider，Mode=Custom

### 3.3 智能适配

- PluginUIAdapter根据插件实现的接口自动判断UI模式
- 统一API，简化插件开发
- 支持动态切换UI模式

### 3.4 团队协作

- 插件隔离，不同团队开发不同插件
- 通过接口通信，不直接依赖
- 统一管理，统一加载

## 四、使用指南

### 4.1 开发新插件

1. **创建插件项目**
   ```
   在Plugins/目录下创建新文件夹
   创建.csproj项目文件
   引用SunEyeVision.Core项目
   ```

2. **实现插件接口**
   ```csharp
   public class MyPlugin : IAlgorithmPlugin
   {
       // 实现IPlugin成员
       public string PluginId => "MyPlugin";
       public string PluginName => "My Plugin";
       // ... 其他成员

       // 实现IAlgorithmPlugin成员
       public ParameterMetadata[] GetParameters() { ... }
       public object Execute(...) { ... }
       // ... 其他成员

       // 可选：实现IPluginUIProvider
       public UIProviderMode Mode => UIProviderMode.Auto;
       public object GetCustomControl() => null;
       public object GetCustomPanel() => null;
   }
   ```

3. **创建plugin.json**
   ```json
   {
     "pluginId": "MyPlugin",
     "pluginName": "My Plugin",
     "version": "1.0.0",
     "description": "My plugin description",
     "author": "My Team"
   }
   ```

4. **编译插件**
   ```
   dotnet build SunEyeVision.Plugins.MyPlugin.csproj
   ```

5. **放置DLL到Plugins目录**
   ```
   将生成的DLL和plugin.json复制到输出目录的Plugins/MyPlugin/文件夹
   ```

6. **运行应用**
   ```
   应用启动时自动加载所有插件
   ```

### 4.2 选择UI模式

**Auto模式（推荐用于简单插件）**
```csharp
public class SimplePlugin : IAlgorithmPlugin
{
    // 只需定义参数元数据
    public ParameterMetadata[] GetParameters()
    {
        return new[]
        {
            new ParameterMetadata { Name = "param1", Type = "int", DefaultValue = 10 }
        };
    }
    // 不实现IPluginUIProvider，自动使用Auto模式
}
```

**Hybrid模式（推荐用于中等复杂插件）**
```csharp
public class HybridPlugin : IAlgorithmPlugin, IPluginUIProvider
{
    public UIProviderMode Mode => UIProviderMode.Hybrid;
    
    public object GetCustomControl() => null; // 使用框架通用控件
    
    public object GetCustomPanel()
    {
        // 使用共享UI组件创建自定义面板
        return new ProgressPanel();
    }
}
```

**Custom模式（推荐用于复杂插件）**
```csharp
public class CustomPlugin : IAlgorithmPlugin, IPluginUIProvider
{
    public UIProviderMode Mode => UIProviderMode.Custom;
    
    public object GetCustomControl()
    {
        // 返回完全自定义的主控件
        return new CustomMainControl();
    }
    
    public object GetCustomPanel()
    {
        // 返回自定义的附加面板
        return new CustomSidePanel();
    }
}
```

### 4.3 使用共享UI组件

```csharp
using SunEyeVision.UI.Shared.Controls.Common;
using SunEyeVision.UI.Shared.Controls.PropertyGrid;
using SunEyeVision.UI.Shared.Controls.ParameterPanel;
using SunEyeVision.UI.Shared.Controls.Visualization;

// 创建进度面板
var progressPanel = new ProgressPanel
{
    ProgressText = "Processing...",
    ProgressValue = 50
};

// 创建状态指示器
var statusIndicator = new StatusIndicator
{
    Status = "Running",
    IsRunning = true
};

// 创建属性网格
var propertyGrid = new GenericPropertyGrid
{
    Properties = new List<PropertyItem>
    {
        new PropertyItem { Name = "param1", Type = "int", DefaultValue = 10 }
    }
};

// 创建参数面板
var parameterPanel = new GenericParameterPanel
{
    Parameters = new Dictionary<string, object>
    {
        { "param1", 10 },
        { "param2", "test" }
    }
};

// 创建图像可视化面板
var imagePanel = new ImageVisualizationPanel
{
    ImageSource = bitmap,
    ImageInfo = "800x600, RGB"
};
```

## 五、下一步工作

### 5.1 短期任务

1. **完善共享UI组件**
   - 添加NumericUpDown控件支持
   - 完善PropertyItemPanel的编辑器类型
   - 添加更多可视化组件

2. **增强PluginManager**
   - 添加插件依赖检查
   - 支持插件热加载/卸载
   - 添加插件版本兼容性检查

3. **完善调试系统**
   - 实现调试控制面板UI
   - 添加断点支持
   - 添加变量监视功能

4. **测试示例插件**
   - 编译并运行三个示例插件
   - 验证三种UI模式
   - 测试插件加载和卸载

### 5.2 中期任务

1. **创建更多示例插件**
   - 图像滤镜插件
   - 工作流节点插件
   - 设备驱动插件

2. **完善文档**
   - 插件开发API文档
   - 共享UI组件API文档
   - 调试系统文档

3. **开发工具**
   - 插件生成器工具
   - 插件打包工具
   - 插件测试工具

### 5.3 长期任务

1. **插件市场**
   - 在线插件库
   - 插件评分和评论
   - 自动更新功能

2. **插件沙箱**
   - 插件隔离运行
   - 资源限制
   - 安全沙箱

3. **性能优化**
   - 插件加载优化
   - UI渲染优化
   - 内存管理优化

## 六、总结

本次实施完成了以下核心工作：

✅ 创建了完整的插件接口体系（IPlugin、IPluginUIProvider、INodePlugin、IAlgorithmPlugin）
✅ 实现了PluginManager插件管理器
✅ 创建了PluginUIAdapter智能UI适配器
✅ 实现了共享UI组件库（PropertyGrid、ParameterPanel、ImageVisualizationPanel、ProgressPanel、StatusIndicator）
✅ 创建了插件调试系统
✅ 创建了面板扩展系统
✅ 创建了三个示例插件（Auto、Hybrid、Custom模式）
✅ 更新了应用程序初始化代码
✅ 生成了完整的文件结构说明文档

新的架构具有以下优势：

✨ 高度解耦：框架与插件通过接口通信，互不依赖
✨ 灵活扩展：支持三种UI模式，满足不同需求
✨ 团队协作：插件隔离，多人开发互不干扰
✨ 代码复用：共享UI组件，减少重复开发
✨ 易于维护：清晰的分层结构，职责明确

## 七、参考资料

- 文件结构说明：`NEW_PROJECT_STRUCTURE.md`
- 插件接口文档：`SunEyeVision.Core/Interfaces/Plugins/`
- 共享UI组件文档：`SunEyeVision.UI/Shared/Controls/`
- 示例插件代码：`Plugins/`

---

**实施日期**：2026-01-28
**实施者**：SunEyeVision Team
**版本**：1.0.0
