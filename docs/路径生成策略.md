# 路径生成策略

## 一、路径策略选择依据

| 场景 | 条件判断 | 选择的策略 | 说明 |
|------|----------|-----------|------|
| **场景1** | 对向端口 + 距离较近<br/>• Left→Right, Right→Left, Top→Bottom, Bottom→Top<br/>• 水平距离 < 60px 且 垂直距离 < 60px | **ThreeSegment** | 相邻且距离近的节点，使用简单的三段折线 |
| **场景2** | 同向端口<br/>• Right→Right, Left→Left, Top→Top, Bottom→Bottom | **FiveSegment** | 确保两个端口都向外延伸，避免穿入目标节点 |
| **场景2** | 正交端口（不同方向）<br/>• 一个水平一个垂直<br/>**且源端口是水平的** | **HorizontalFirst** | 如果水平距离 > 垂直距离 |
| **场景2** | 正交端口（不同方向）<br/>• 一个水平一个垂直<br/>**且源端口是水平的** | **VerticalFirst** | 如果水平距离 ≤ 垂直距离 |
| **场景2** | 正交端口（不同方向）<br/>• 一个水平一个垂直<br/>**且源端口是垂直的** | **VerticalFirst** | 如果垂直距离 > 水平距离 |
| **场景2** | 正交端口（不同方向）<br/>• 一个水平一个垂直<br/>**且源端口是垂直的** | **HorizontalFirst** | 如果垂直距离 ≤ 水平距离 |
| **场景3** | 默认情况<br/>对向端口但距离较远 | **HorizontalFirst** | 如果源端口是水平的 |
| **场景3** | 默认情况<br/>对向端口但距离较远 | **VerticalFirst** | 如果源端口是垂直的 |

### 关键参数

| 参数名 | 值 | 说明 |
|-------|-----|------|
| MinSegmentLength | 30.0 | 最小线段长度，避免过短的折线 |
| ArrowLength | 15.0 | 箭头长度 |
| 距离较近阈值 | 60.0 | MinSegmentLength × 2，用于判断是否使用三段式策略 |

---

## 二、不同策略下的路径点生成逻辑

| 策略 | 路径点数量 | 路径模式 | 路径点详细说明 |
|------|----------|---------|--------------|
| **HorizontalFirst** | 4个点 | 水平-垂直-水平 | 1. **起点**: sourcePosition<br/>2. **拐点1**: 从起点沿源方向水平延伸 offset 距离<br/>   - offset = Max(30, \|dx\| × 0.3)<br/>3. **拐点2**: 从拐点1垂直延伸到目标Y坐标<br/>4. **终点**: targetPosition（箭头尾部） |
| **VerticalFirst** | 4个点 | 垂直-水平-垂直 | 1. **起点**: sourcePosition<br/>2. **拐点1**: 从起点沿源方向垂直延伸 offset 距离<br/>   - offset = Max(30, \|dy\| × 0.3)<br/>3. **拐点2**: 从拐点1水平延伸到目标X坐标<br/>4. **终点**: targetPosition（箭头尾部） |
| **ThreeSegment** | 3个点 | 水平-垂直 **或** 垂直-水平 | 1. **起点**: sourcePosition<br/>2. **中间点**: 根据源端口方向选择<br/>   - 源端口水平: 中间点 = (targetPosition.X, sourcePosition.Y)<br/>   - 源端口垂直: 中间点 = (sourcePosition.X, targetPosition.Y)<br/>3. **终点**: targetPosition（箭头尾部） |
| **FiveSegment** | 5个点 | 复杂的五段折线 | 1. **起点**: sourcePosition<br/>2. **拐点1**: 从起点沿源方向延伸 extendDistance<br/>   - extendDistance = Max(60, Max(\|dx\|, \|dy\|) × 0.4)<br/>3. **拐点2**: 根据端口方向计算<br/>   - 源端口水平: (p1.X, sourcePosition.Y和targetPosition.Y的中点)<br/>   - 源端口垂直: (sourcePosition.X和targetPosition.X的中点, p1.Y)<br/>4. **拐点3**: 根据端口方向计算<br/>   - 源端口水平: (targetPosition.X, sourcePosition.Y和targetPosition.Y的中点)<br/>   - 源端口垂直: (sourcePosition.X和targetPosition.X的中点, targetPosition.Y)<br/>5. **终点**: targetPosition（箭头尾部） |

---

## 三、箭头信息

| 端口方向 | 箭头角度 | 箭头指向 | 箭头长度 |
|---------|---------|---------|---------|
| Left | 0° | 向右 | 15px |
| Right | 180° | 向左 | 15px |
| Top | 90° | 向下 | 15px |
| Bottom | 270° | 向上 | 15px |

**注**: 箭头角度固定为目标端口方向，不受源节点或路径方向影响。

---

## 四、路径终点说明

当前实现中：
- **箭头尖端** = 目标端口中心（箭头指向节点内部）
- **箭头尾部** = 端口中心 + 沿端口方向向外偏移箭头长度（15px）
- **路径终点** = 箭头尾部（路径到达箭头尾部停止，箭头尖端由箭头几何渲染）

此设计确保：
1. 箭头明确指向目标节点内部
2. 路径不会穿入节点内部
3. 箭头位置和角度基于目标端口方向固定，不受源节点影响
