#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
SunEyeVision 编码问题修复脚本 v6
修复UTF-8中文被截断的问题
使用二进制模式读取，处理Unicode替换字符
"""

import os
import re
import sys
from pathlib import Path
from typing import List, Tuple

# 设置输出编码
if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')

# 修复映射
FIXES = {
    '调?': '调试', '信?': '信息', '接?': '接口', '结?': '结果',
    '问?': '问题', '配?': '配置', '文?': '文件', '数?': '数据',
    '时?': '时间', '次?': '次数', '比?': '比例', '态?': '状态',
    '置?': '设置', '项?': '项目', '类?': '类型', '方?': '方法',
    '功?': '功能', '属?': '属性', '参?': '参数', '变?': '变量',
    '表?': '列表', '集?': '集合', '对?': '对象', '实?': '实例',
    '模?': '模块', '组?': '组件', '系?': '系统', '程?': '程序',
    '流?': '流程', '器?': '管理器', '场?': '场景', '操?': '操作',
    '执?': '执行', '运?': '运行', '停?': '停止', '启?': '启动',
    '载?': '加载', '存?': '保存', '删?': '删除', '添?': '添加',
    '修?': '修改', '更?': '更新', '创?': '创建', '初?': '初始',
    '清?': '清理', '释?': '释放', '销?': '销毁', '复?': '复制',
    '撤?': '撤销', '重?': '重做', '恢?': '恢复', '进?': '进度',
    '错?': '错误', '异?': '异常', '警?': '警告', '提?': '提示',
    '消?': '消息', '日?': '日志', '记?': '记录', '监?': '监控',
    '测?': '测试', '验?': '验证', '检?': '检查', '确?': '确认',
    '取?': '取消', '禁?': '禁止', '过?': '过滤', '排?': '排序',
    '分?': '分组', '统?': '统计', '计?': '计算', '处?': '处理',
    '解?': '解析', '转?': '转换', '格?': '格式', '编?': '编码',
    '压?': '压缩', '连?': '连接', '断?': '断开', '发?': '发送',
    '节?': '节点', '元?': '元素', '条?': '条件', '规?': '规则',
    '策?': '策略', '算?': '算法', '视?': '视图', '控?': '控件',
    '窗?': '窗口', '工?': '工具', '状?': '状态', '图?': '图像',
    '效?': '效果', '事?': '事件', '命?': '命令', '绑?': '绑定',
    '线?': '线程', '同?': '同步', '异?': '异步', '队?': '队列',
    '缓?': '缓存', '池?': '池', '内?': '内存', '磁?': '磁盘',
    '网?': '网络', '键?': '键', '值?': '值', '空?': '空值',
    '默?': '默认', '自?': '自动', '手?': '手动', '全?': '全局',
    '局?': '局部', '公?': '公共', '私?': '私有', '静?': '静态',
    '动?': '动态', '常?': '常量', '只?': '只读', '可?': '可写',
    '输?': '输入', '返?': '返回', '泛?': '泛型', '继?': '继承',
    '重?': '重写', '覆?': '覆盖', '封?': '封装', '抽?': '抽象',
    '虚?': '虚方法', '枚?': '枚举', '索?': '索引', '构?': '构造',
    '析?': '析构', '源?': '源', '目?': '目标', '路?': '路径',
    '地?': '地址', '端?': '端口', '客?': '客户端', '服?': '服务',
    '响?': '响应', '请?': '请求', '接?': '接收', '登?': '登录',
    '注?': '注册', '退?': '退出', '导?': '导航', '布?': '布局',
    '样?': '样式', '主?': '主题', '资?': '资源', '动?': '动画',
    '过?': '过渡', '触?': '触发', '回?': '回调', '委?': '委托',
    '任?': '任务', '并?': '并行', '串?': '串行', '栈?': '栈',
    '堆?': '堆', '字?': '字段', '唯?': '唯一', '外?': '外键',
    '主?': '主键', '相?': '相对', '绝?': '绝对', '水?': '水平',
    '垂?': '垂直', '位?': '位置', '区?': '区域', '范?': '范围',
    '大?': '大小', '尺?': '尺寸', '宽?': '宽度', '高?': '高度',
    '边?': '边框', '填?': '填充', '颜?': '颜色', '背?': '背景',
    '前?': '前景', '透?': '透明', '显?': '显示', '隐?': '隐藏',
    '折?': '折叠', '展?': '展开', '锁?': '锁定', '选?': '选择',
    '焦?': '焦点', '滚?': '滚动', '缩?': '缩放', '旋?': '旋转',
    '移?': '移动', '剪?': '剪切', '查?': '查找', '替?': '替换',
    '跳?': '跳转', '刷?': '刷新', '完?': '完成', '应?': '应用',
    '重?': '重置', '帮?': '帮助', '关?': '关于', '版?': '版本',
    '作?': '作者', '权?': '版权', '许?': '许可', '协?': '协议',
    '文?': '文档', '示?': '示例', '教?': '教程', '指?': '指南',
    '手?': '手册', '参?': '参考', '链?': '链接', '下?': '下载',
    '上?': '上传', '导?': '导出', '导?': '导入', '打?': '打开',
    '关?': '关闭', '新?': '新建', '编?': '编辑', '保?': '保存',
    '另?': '另存为', '打?': '打印', '预?': '预览', '发?': '发布',
    '部?': '部署', '调?': '调试', '暂?': '暂停', '继?': '继续',
    '步?': '步进', '断?': '断点', '堆?': '堆栈', '插?': '插件',
    '扩?': '扩展', '皮?': '皮肤', '语?': '语言', '选?': '选项',
    '首?': '首选', '环?': '环境', '面?': '面板', '标?': '标签',
    '详?': '详情', '摘?': '摘要', '大?': '大纲', '缩?': '缩略',
    '图?': '图标', '树?': '树形', '网?': '网格', '表?': '表格',
    '图?': '图表', '报?': '报表', '警?': '警告', '提?': '提示',
    '解?': '解决方案', '文?': '文件夹', '目?': '目录', '名?': '名称',
    '日?': '日期', '版?': '版本', '作?': '操作', '输?': '输出',
    '输?': '输入',
}

# 上下文修复
CONTEXT_FIXES = [
    (r'用于开发调\?', '用于开发调试'),
    (r'一般信\?', '一般信息'),
    (r'配置管理器接\?', '配置管理器接口'),
    (r'工作流执行结\?', '工作流执行结果'),
    (r'是否被停\?', '是否被停止'),
    (r'进度百分\?', '进度百分比'),
    (r'总迭代次\?', '总迭代次数'),
    (r'执行开始时\?', '执行开始时间'),
    (r'中文乱码问\?', '中文乱码问题'),
    (r'绑定信\?', '绑定信息'),
    (r'所有配\?', '所有配置'),
    (r'保存配置到文\?', '保存配置到文件'),
    (r'从文件加载配\?', '从文件加载配置'),
    (r'加载所有配\?', '加载所有配置'),
    (r'另一个执行结\?', '另一个执行结果'),
    (r'合并另一个执行结\?', '合并另一个执行结果'),
]

def find_cs_files(root_dir: Path) -> List[Path]:
    cs_files = []
    for root, dirs, files in os.walk(root_dir):
        dirs[:] = [d for d in dirs if d not in ['obj', 'bin', '.git']]
        for file in files:
            if file.endswith('.cs'):
                cs_files.append(Path(root) / file)
    return cs_files

def fix_content(content: str) -> Tuple[str, int]:
    fix_count = 0
    
    # Unicode替换字符
    replacement_char = '\ufffd'
    
    if replacement_char not in content:
        return content, 0
    
    # 上下文修复
    for pattern, correct in CONTEXT_FIXES:
        if re.search(pattern, content):
            matches = re.findall(pattern, content)
            content = re.sub(pattern, correct, content)
            fix_count += len(matches)
    
    # 单字符修复 - 中文 + 替换字符
    for wrong, correct in FIXES.items():
        # 构建带替换字符的模式
        pattern = wrong.replace('?', replacement_char)
        if pattern in content:
            count = content.count(pattern)
            content = content.replace(pattern, correct)
            fix_count += count
    
    return content, fix_count

def main():
    print("=" * 70)
    print("SunEyeVision 编码问题修复脚本 v6")
    print("=" * 70)
    
    src_dir = Path(__file__).parent / 'src'
    if not src_dir.exists():
        print("错误: 找不到src目录")
        return
    
    print(f"\n扫描目录: {src_dir}")
    cs_files = find_cs_files(src_dir)
    print(f"找到 {len(cs_files)} 个C#文件")
    
    print("\n分析文件...")
    results = []
    
    for file_path in cs_files:
        try:
            # 使用UTF-8读取，替换无法解码的字节
            with open(file_path, 'r', encoding='utf-8', errors='replace') as f:
                content = f.read()
            
            # 检查是否有替换字符
            if '\ufffd' in content:
                fixed, count = fix_content(content)
                if count > 0:
                    rel = file_path.relative_to(src_dir.parent)
                    results.append((file_path, str(rel), count, fixed))
        except Exception as e:
            pass
    
    print(f"\n发现 {len(results)} 个文件需要修复")
    
    if not results:
        print("没有发现需要修复的问题!")
        return
    
    # 排序显示
    results.sort(key=lambda x: x[2], reverse=True)
    total = sum(r[2] for r in results)
    
    print(f"\n问题文件列表 (前50个):")
    print("-" * 70)
    for _, rel, count, _ in results[:50]:
        print(f"  {rel} ({count}处)")
    if len(results) > 50:
        print(f"  ... 还有 {len(results) - 50} 个文件")
    
    print(f"\n总计: {len(results)} 个文件, {total} 处问题")
    
    print("\n" + "=" * 70)
    print("警告: 修复将覆盖原文件!")
    print("=" * 70)
    
    ans = input("\n执行修复? (y/n): ").strip().lower()
    if ans != 'y':
        print("已取消")
        return
    
    print("\n修复中...")
    fixed_count = 0
    for file_path, rel, count, content in results:
        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"  OK: {rel} ({count}处)")
            fixed_count += 1
        except Exception as e:
            print(f"  失败: {rel}: {e}")
    
    print(f"\n完成! 修复了 {fixed_count} 个文件, 共 {total} 处问题")

if __name__ == '__main__':
    main()
