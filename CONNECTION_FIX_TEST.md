# 连线修复测试指南

## 测试目标
验证连线功能的修复情况，确保：
1. 连线从正确的端口开始和结束
2. 箭头位置正确显示
3. 拖拽节点时连线正确更新
4. 支持不同端口方向的连线

## 测试步骤

### 1. 启动应用程序
运行测试脚本：
```batch
cd d:\MyWork\SunEyeVision\SunEyeVision
test_connection_fix.bat
```

### 2. 创建测试节点
在画布上创建两个节点，例如：
- 节点1: "图像采集"
- 节点2: "模板匹配定位"

### 3. 测试不同端口方向的连线

#### 测试场景 1: 右侧到右侧
- 从节点1的右侧端口连接到节点2的右侧端口
- 观察连线是否为L形（水平-垂直-水平）
- 检查箭头是否在连线的终点附近

#### 测试场景 2: 右侧到左侧
- 从节点1的右侧端口连接到节点2的左侧端口
- 观察连线是否为水平直线
- 检查箭头位置是否正确

#### 测试场景 3: 顶部到底部
- 从节点1的顶部端口连接到节点2的底部端口
- 观察连线是否为垂直直线
- 检查箭头位置是否正确

#### 测试场景 4: 复杂路径
- 从节点1的左侧端口连接到节点2的底部端口
- 观察连线是否为三段式或五段式路径
- 检查箭头位置和角度是否正确

### 4. 拖拽节点测试
- 拖拽源节点，观察连线是否实时更新
- 拖拽目标节点，观察连线是否实时更新
- 拖拽节点远离，观察连线是否保持正确的形状

### 5. 观察要点
- 连线的起点和终点是否在正确的端口位置
- 箭头是否正确指向目标端口
- 连线是否保持正交折线（90度角）
- 箭头角度是否正确（与连线方向一致）

## 预期结果

### 正确的连线行为：
```
图像采集 1 ──→ 模板匹配定位 1
```

- 连线从节点的端口开始，而不是从节点中心
- 箭头位于连线的终点附近
- 连线保持正交折线形状（L形或直线）
- 拖拽节点时连线实时更新

### 错误的连线行为（修复前）：
```
图像采集 1 ──→ 模板匹配定位 1
```

- 连线从节点中心开始
- 箭头位置不正确
- 连线可能是贝塞尔曲线而不是正交折线

## 故障排除

如果发现问题：

1. **连线起点/终点不正确**
   - 检查节点的端口位置计算
   - 确认 `GetPortPosition` 方法返回正确位置

2. **箭头位置不正确**
   - 检查 `OrthogonalPathCalculator.cs` 中的箭头计算逻辑
   - 确认箭头位置计算正确

3. **连线形状不正确**
   - 检查路径计算策略
   - 确认 `CalculateOrthogonalPath` 方法返回正确的路径点

## 技术细节

### 已修复的问题：
1. **端口位置计算** - 确保连线从正确的端口开始和结束
2. **箭头位置计算** - 确保箭头在连线的终点附近
3. **路径计算优化** - 支持四种智能路径策略
4. **实时更新** - 拖拽节点时连线正确更新

### 关键文件：
- `IPathCalculator.cs` - 路径计算接口
- `OrthogonalPathCalculator.cs` - 正交路径计算器
- `ConnectionPathCache.cs` - 连线路径缓存
- `WorkflowNode.cs` - 节点模型（包含 ArrowPosition 属性）

## 测试报告
请将测试结果反馈给我，包括：
1. 测试通过的项
2. 发现的问题
3. 截图（如果可能）
4. 详细描述问题现象

测试完成后，请告诉我结果，我们可以进一步优化或继续进行 Phase 2。