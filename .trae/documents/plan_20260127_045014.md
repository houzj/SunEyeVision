# 画布性能优化方案

## 目标
将画布容量从当前的 ~100 节点提升到 ~2000+ 节点，性能提升 50-100x

## 实施计划

### 阶段一：立即优化（高优先级）
1. **日志系统优化**
   - 实现日志级别控制（Debug/Info/Error）
   - 高频事件使用采样日志
   - Release 模式禁用日志
   - 预期：CPU 降低 30-50%

2. **节点查找优化**
   - 创建 `Dictionary<string, WorkflowNode>` 索引
   - 连接线计算使用字典查找
   - 预期：连接线渲染提升 10-20x

3. **HitTest 优化**
   - 实现空间索引（QuadTree 或 GridSpatialIndex）
   - 只对视口内节点进行 HitTest
   - 使用边界矩形预筛选
   - 预期：100 节点时提升 5-10x

### 阶段二：架构优化（中优先级）
4. **画布虚拟化**
   - 创建 `VirtualizedCanvas` 控件
   - 只渲染视口内的节点和连接线
   - 预期：1000 节点时提升 50-100x

5. **批量更新机制**
   - 实现 `BatchUpdateScope` 类
   - 批量操作期间暂停通知
   - 预期：批量操作提升 5-10x

6. **连接线路径缓存**
   - 在 `WorkflowConnection` 中缓存 `PathData`
   - 节点位置变化时标记为脏
   - 预期：连接线渲染提升 3-5x

### 阶段三：渲染优化（中优先级）
7. **DrawingContext 渲染**
   - 创建 `CanvasRenderer` 类
   - 直接绘制节点和连接线
   - 预期：渲染提升 2-3x

8. **连接线几何优化**
   - 使用 `StreamGeometry` 替代 `PathGeometry`
   - 共享几何对象
   - 预期：连接线渲染提升 2-4x

9. **节点模板简化**
   - 简化 XAML 模板
   - 减少视觉树复杂度
   - 预期：节点渲染提升 1.5-2x

### 阶段四：高级优化（低优先级）
10. **GPU 加速**
    - 使用 `D3DImage` 或 `WriteableBitmap`
    - 自定义渲染管线
    - 预期：渲染提升 5-10x

11. **多线程渲染**
    - 后台线程计算路径
    - 使用 `Dispatcher` 更新 UI
    - 预期：UI 响应性提升 2-3x

12. **对象池**
    - 实现 `ObjectPool<T>` 类
    - 池化临时对象
    - 预期：GC 暂停减少 50-70%

## 预期效果
- 阶段一完成后：支持 ~500 节点，性能提升 10-50x
- 阶段二完成后：支持 ~2000 节点，性能提升 50-100x
- 阶段三完成后：支持 ~5000 节点，性能提升 100-200x
- 阶段四完成后：支持 ~10000+ 节点，性能提升 200-500x

## 推荐实施顺序
1. 立即实施（1-2 天）：日志优化、节点索引
2. 短期实施（1 周）：HitTest 优化、批量更新
3. 中期实施（2-3 周）：虚拟化、路径缓存、DrawingContext
4. 长期实施（1-2 月）：GPU 加速、多线程、对象池