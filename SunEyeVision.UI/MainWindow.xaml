<Window x:Class="SunEyeVision.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SunEyeVision.UI"
        xmlns:vm="clr-namespace:SunEyeVision.UI.ViewModels"
        xmlns:converters="clr-namespace:SunEyeVision.UI.Converters"
        xmlns:controls="clr-namespace:SunEyeVision.UI.Controls"
        mc:Ignorable="d"
        Title="å¤ªé˜³çœ¼è§†è§‰ - æœºå™¨è§†è§‰å¹³å°" Height="900" Width="1600"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        Background="#FFFFFF"
        Loaded="MainWindow_Loaded">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Resources/AppResources.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <converters:SmartPathConverter x:Key="SmartPathConverter" ControlOffset="60" GridSize="20" NodeMargin="30"/>
        </ResourceDictionary>
    </Window.Resources>

    <DockPanel>
        <!-- ========== é¡¶éƒ¨èœå•æ  (28px) ========== -->
        <Menu DockPanel.Dock="Top" Height="28" Background="{StaticResource HeaderBrush}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
            <MenuItem Header="æ–‡ä»¶(_F)">
                <MenuItem Header="æ–°å»ºæ–¹æ¡ˆ(_N)" Command="{Binding NewWorkflowCommand}" InputGestureText="Ctrl+N"/>
                <MenuItem Header="æ‰“å¼€æ–¹æ¡ˆ(_O)" Command="{Binding OpenWorkflowCommand}" InputGestureText="Ctrl+O"/>
                <MenuItem Header="ä¿å­˜æ–¹æ¡ˆ(_S)" Command="{Binding SaveWorkflowCommand}" InputGestureText="Ctrl+S"/>
                <MenuItem Header="å¦å­˜ä¸º(_A)" Command="{Binding SaveAsWorkflowCommand}" InputGestureText="Ctrl+Shift+S"/>
                <Separator/>
                <MenuItem Header="å¯¼å…¥(_I)" InputGestureText="Ctrl+I"/>
                <MenuItem Header="å¯¼å‡º(_E)" InputGestureText="Ctrl+E"/>
                <Separator/>
                <MenuItem Header="æœ€è¿‘æ–‡ä»¶"/>
                <Separator/>
                <MenuItem Header="é€€å‡º(_X)" InputGestureText="Alt+F4"/>
            </MenuItem>
            <MenuItem Header="ç¼–è¾‘(_E)">
                <MenuItem Header="æ’¤é”€(_U)" InputGestureText="Ctrl+Z"/>
                <MenuItem Header="é‡åš(_R)" InputGestureText="Ctrl+Y"/>
                <Separator/>
                <MenuItem Header="å¤åˆ¶(_C)" InputGestureText="Ctrl+C"/>
                <MenuItem Header="ç²˜è´´(_V)" InputGestureText="Ctrl+V"/>
                <MenuItem Header="åˆ é™¤(_D)" InputGestureText="Del"/>
                <Separator/>
                <MenuItem Header="å…¨é€‰(_A)" InputGestureText="Ctrl+A"/>
                <MenuItem Header="æŸ¥æ‰¾(_F)" InputGestureText="Ctrl+F"/>
                <MenuItem Header="æ›¿æ¢(_H)" InputGestureText="Ctrl+H"/>
            </MenuItem>
            <MenuItem Header="è§†å›¾(_V)">
                <MenuItem Header="æ–¹æ¡ˆæ ‘(_S)"/>
                <MenuItem Header="å·¥å…·ç®±(_T)"/>
                <MenuItem Header="è®¾å¤‡ç®¡ç†(_D)"/>
                <MenuItem Header="å±žæ€§é¢æ¿(_P)"/>
                <MenuItem Header="æ—¥å¿—çª—å£(_L)"/>
                <MenuItem Header="ç»“æžœé¢„è§ˆ(_R)"/>
                <MenuItem Header="ç³»ç»Ÿä¿¡æ¯(_I)"/>
                <Separator/>
                <MenuItem Header="æ˜¾ç¤ºæœ€å¤§å¤–æŽ¥çŸ©å½¢(_B)" InputGestureText="Ctrl+B" Command="{Binding ToggleBoundingRectangleCommand}"/>
                <MenuItem Header="æ˜¾ç¤ºè·¯å¾„æ‹ç‚¹(_P)" InputGestureText="Ctrl+P" Command="{Binding TogglePathPointsCommand}"/>
                <Separator/>
                <MenuItem Header="å…¨å±(_F)" InputGestureText="F11"/>
                <MenuItem Header="é‡ç½®å¸ƒå±€(_R)"/>
            </MenuItem>
            <MenuItem Header="è¿è¡Œ(_R)">
                <MenuItem Header="è¿è¡Œ(_R)" Command="{Binding RunWorkflowCommand}" InputGestureText="F5"/>
                <MenuItem Header="åœæ­¢(_S)" Command="{Binding StopWorkflowCommand}" InputGestureText="Shift+F5"/>
                <MenuItem Header="æš‚åœ(_P)" InputGestureText="Ctrl+Break"/>
                <Separator/>
                <MenuItem Header="è°ƒè¯•æ¨¡å¼(_D)" InputGestureText="Ctrl+Shift+D"/>
                <MenuItem Header="å•æ­¥æ‰§è¡Œ(_S)" InputGestureText="F10"/>
                <MenuItem Header="æ–­ç‚¹(_B)" InputGestureText="F9"/>
            </MenuItem>
            <MenuItem Header="å·¥å…·(_T)">
                <MenuItem Header="ç›¸æœºé…ç½®(_C)"/>
                <MenuItem Header="å‚æ•°ç®¡ç†(_P)"/>
                <MenuItem Header="æ’ä»¶ç®¡ç†(_L)"/>
                <MenuItem Header="ç³»ç»Ÿè®¾ç½®(_S)"/>
                <MenuItem Header="å¿«æ·é”®è®¾ç½®(_K)"/>
            </MenuItem>
            <MenuItem Header="æ’ä»¶(_P)">
                <MenuItem Header="æ’ä»¶å¸‚åœº(_M)"/>
                <MenuItem Header="å®‰è£…æ’ä»¶(_I)"/>
                <MenuItem Header="å¯ç”¨/ç¦ç”¨(_D)"/>
                <MenuItem Header="æ’ä»¶æ›´æ–°(_U)"/>
            </MenuItem>
            <MenuItem Header="å¸®åŠ©(_H)">
                <MenuItem Header="ç”¨æˆ·æ‰‹å†Œ(_M)" InputGestureText="F1" Command="{Binding ShowHelpCommand}"/>
                <MenuItem Header="APIæ–‡æ¡£(_D)"/>
                <MenuItem Header="å¿«æ·é”®(_K)" Command="{Binding ShowShortcutsCommand}"/>
                <MenuItem Header="å…³äºŽ(_A)" Command="{Binding ShowAboutCommand}"/>
            </MenuItem>
        </Menu>

        <!-- ========== å·¥å…·æ  (40px) ========== -->
        <ToolBar DockPanel.Dock="Top" Height="40" Background="{StaticResource HeaderBrush}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
            <!-- æ–‡ä»¶æ“ä½œç»„ -->
            <Button ToolTip="æ–°å»º (Ctrl+N)" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}" Command="{Binding NewWorkflowCommand}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ“„" FontSize="16" VerticalAlignment="Center"/>
                    <TextBlock Text="æ–°å»º" Margin="5,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
            <Button ToolTip="æ‰“å¼€ (Ctrl+O)" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}" Command="{Binding OpenWorkflowCommand}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ“‚" FontSize="16" VerticalAlignment="Center"/>
                    <TextBlock Text="æ‰“å¼€" Margin="5,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
            <Button ToolTip="ä¿å­˜ (Ctrl+S)" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}" Command="{Binding SaveWorkflowCommand}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ’¾" FontSize="16" VerticalAlignment="Center"/>
                    <TextBlock Text="ä¿å­˜" Margin="5,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Separator/>

            <!-- æ‰§è¡ŒæŽ§åˆ¶ç»„ -->
            <Button ToolTip="è¿è¡Œ (F5)" Padding="8,4" Margin="2" Style="{StaticResource PrimaryButton}" Command="{Binding RunWorkflowCommand}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="â–¶ï¸" FontSize="16" VerticalAlignment="Center"/>
                    <TextBlock Text="è¿è¡Œ" Margin="5,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
            <Button ToolTip="åœæ­¢ (Shift+F5)" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}" Command="{Binding StopWorkflowCommand}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="â¹ï¸" FontSize="16" VerticalAlignment="Center"/>
                    <TextBlock Text="åœæ­¢" Margin="5,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Separator/>

            <!-- å·¥ä½œæµç®¡ç†ç»„ -->
            <ComboBox Width="150" Height="32" Margin="8,0,4,0" VerticalAlignment="Center"
                     ItemsSource="{Binding WorkflowTabViewModel.Tabs}"
                     SelectedItem="{Binding WorkflowTabViewModel.SelectedTab, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     DisplayMemberPath="Name"
                     IsSynchronizedWithCurrentItem="True"
                     ToolTip="å¿«é€Ÿåˆ‡æ¢å·¥ä½œæµ"
                     Style="{StaticResource StyledComboBox}"/>

            <Separator/>

            <!-- è°ƒè¯•å·¥å…·ç»„ -->
            <Button ToolTip="å•æ­¥æ‰§è¡Œ (F10)" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ”" FontSize="16" VerticalAlignment="Center"/>
                    <TextBlock Text="è°ƒè¯•" Margin="5,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Separator/>

            <!-- ç¼–è¾‘æ“ä½œç»„ -->
            <Button ToolTip="æ’¤é”€ (Ctrl+Z)" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}">
                <TextBlock Text="â†©ï¸" FontSize="16" VerticalAlignment="Center"/>
            </Button>
            <Button ToolTip="é‡åš (Ctrl+Y)" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}">
                <TextBlock Text="â†ªï¸" FontSize="16" VerticalAlignment="Center"/>
            </Button>

            <Separator/>

            <!-- è§†å›¾æŽ§åˆ¶ç»„ -->
            <Button ToolTip="æ”¾å¤§" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}" Click="ZoomIn_Click">
                <TextBlock Text="ðŸ”Ž+" FontSize="14" VerticalAlignment="Center"/>
            </Button>
            <Button ToolTip="ç¼©å°" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}" Click="ZoomOut_Click">
                <TextBlock Text="ðŸ”Ž-" FontSize="14" VerticalAlignment="Center"/>
            </Button>
            <Button ToolTip="é€‚åº”çª—å£" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}" Click="ZoomFit_Click">
                <TextBlock Text="ðŸ“" FontSize="16" VerticalAlignment="Center"/>
            </Button>
            <Button ToolTip="100%" Padding="8,4" Margin="2" Style="{StaticResource SecondaryButton}" Click="ZoomReset_Click">
                <TextBlock Text="1:1" FontSize="14" VerticalAlignment="Center" FontWeight="Bold"/>
            </Button>

            <Separator/>

            <TextBlock x:Name="ZoomText" Text="ç¼©æ”¾: 100%" VerticalAlignment="Center" Margin="8,0,4,0" FontSize="12" Foreground="#666666"/>
        </ToolBar>


        <!-- ========== ä¸»å†…å®¹åŒºåŸŸ ========== -->
        <Grid x:Name="MainContentGrid" Loaded="MainContentGrid_Loaded">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="260" x:Name="ToolboxColumn" MinWidth="40" MaxWidth="600"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*" x:Name="WorkflowColumn" MinWidth="400"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="500" x:Name="RightPanelColumn" MinWidth="40" MaxWidth="800"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="24"/>
            </Grid.RowDefinitions>

            <!-- ========== å·¦ä¾§å·¥å…·åŒº - ä½¿ç”¨ToolboxControl ========== -->
            <Border Grid.Column="0" Background="#F8F8F8" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- å·¥å…·ç®±æ ‡é¢˜ -->
                    <Border Grid.Row="0" Background="#FFFFFF" BorderBrush="#CCCCCC" BorderThickness="0,0,0,1" Padding="8,4">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“¦" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBlock Text="å·¥å…·ç®±" FontWeight="Bold" FontSize="12" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- å·¥å…·ç®±å†…å®¹ -->
                    <controls:ToolboxControl Grid.Row="1" DataContext="{Binding Toolbox}" x:Name="ToolboxContent"/>
                </Grid>
            </Border>

            <!-- å·¦ä¾§åˆ†å‰²å™¨ - å·¥å…·ç®±å’Œå·¥ä½œåŒºä¹‹é—´ -->
            <controls:SplitterWithToggle Grid.Column="1" Width="8" MinWidth="8"
                                         ResizeDirection="Columns"
                                         ToggleDirection="Left"
                                         x:Name="ToolboxSplitter"
                                         ToggleClicked="ToolboxSplitter_ToggleClick"/>

            <!-- ========== ä¸­é—´å·¥ä½œåŒº - TabControlå¤šæµç¨‹ç¼–è¾‘ ========== -->
            <Border Grid.Column="2" Background="#F5F5F5" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0">
                <TabControl x:Name="WorkflowTabControl"
                            Background="#F5F5F5"
                            BorderThickness="0"
                            ItemsSource="{Binding WorkflowTabViewModel.Tabs}"
                            SelectedItem="{Binding WorkflowTabViewModel.SelectedTab, Mode=TwoWay}"
                            IsSynchronizedWithCurrentItem="True"
                            SelectionChanged="WorkflowTabControl_SelectionChanged"
                            PreviewMouseLeftButtonDown="WorkflowTabControl_PreviewMouseLeftButtonDown"
                            Loaded="WorkflowTabControl_Loaded">
                    <TabControl.Resources>
                        <converters:WorkflowStateToColorConverter x:Key="WorkflowStateToColorConverter"/>
                        <converters:WorkflowStateToTextConverter x:Key="WorkflowStateToTextConverter"/>
                        <converters:ContinuousRunButtonTextConverter x:Key="ContinuousRunButtonTextConverter"/>
                        <converters:ContinuousRunBackgroundConverter x:Key="ContinuousRunBackgroundConverter"/>
                        <converters:ContinuousRunBorderConverter x:Key="ContinuousRunBorderConverter"/>
                        <converters:ContinuousRunIconTriangleInLoopConverter x:Key="ContinuousRunIconTriangleInLoopConverter"/>
                        <converters:ContinuousRunIconColorConverter x:Key="ContinuousRunIconColorConverter"/>
                    </TabControl.Resources>

                    <!-- è‡ªå®šä¹‰TabControlæ¨¡æ¿,å°†æ·»åŠ æŒ‰é’®æ”¾åœ¨TabPanelä¸­ -->
                    <TabControl.Template>
                        <ControlTemplate TargetType="TabControl">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- TabPanelåŒºåŸŸ,åˆ†ä¸ºä¸¤åˆ—:å·¦ä¾§TabItemså¯æ»šåŠ¨,å³ä¾§æ·»åŠ æŒ‰é’®å›ºå®š -->
                                <Border Grid.Row="0" Background="#F5F5F5" BorderThickness="0,0,0,1" BorderBrush="#E0E0E0"
                                        ClipToBounds="True">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>  <!-- å·¦ä¾§:TabItemsåŒºåŸŸ -->
                                            <ColumnDefinition Width="Auto"/> <!-- å³ä¾§:æ·»åŠ æŒ‰é’®åŒºåŸŸ -->
                                        </Grid.ColumnDefinitions>

                                        <!-- å·¦ä¾§:ScrollVieweråŒ…è£¹TabPanelå’Œå¯æ»šåŠ¨æ·»åŠ æŒ‰é’® -->
                                        <ScrollViewer Grid.Column="0"
                                                      x:Name="TabPanelScrollViewer"
                                                      HorizontalScrollBarVisibility="Hidden"
                                                      VerticalScrollBarVisibility="Disabled"
                                                      Focusable="False"
                                                      ClipToBounds="True">
                                            <StackPanel Orientation="Horizontal">
                                                <TabPanel x:Name="HeaderPanel"
                                                          IsItemsHost="True"/>
                                                
                                                <!-- å¯æ»šåŠ¨ä½ç½®çš„æ·»åŠ æŒ‰é’® - å½“TabItemså¤šæ—¶éšè— -->
                                                <Border x:Name="ScrollableAddButtonBorder"
                                                        Visibility="Collapsed"
                                                        Background="#F5F5F5" Padding="2,2,8,0"
                                                        Margin="4,2,0,0">
                                                    <Button Width="40" Height="40"
                                                            Padding="0"
                                                            BorderThickness="1"
                                                            BorderBrush="#4CAF50"
                                                            Background="#F1F8E9"
                                                            Cursor="Hand"
                                                            Click="AddWorkflow_Click">
                                                        <Button.Template>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border x:Name="ButtonBorder"
                                                                        Background="{TemplateBinding Background}"
                                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                                        BorderThickness="{TemplateBinding BorderThickness}"
                                                                        CornerRadius="6"
                                                                        Width="{TemplateBinding Width}"
                                                                        Height="{TemplateBinding Height}">
                                                                    <Path x:Name="ButtonIcon"
                                                                          Data="M12,6 L12,18 M6,12 L18,12"
                                                                          Stroke="#4CAF50"
                                                                          StrokeThickness="2.5"
                                                                          Fill="Transparent"
                                                                          Stretch="Uniform"
                                                                          Width="20" Height="20"
                                                                          HorizontalAlignment="Center"
                                                                          VerticalAlignment="Center"/>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter TargetName="ButtonBorder" Property="Background" Value="#4CAF50"/>
                                                                        <Setter TargetName="ButtonBorder" Property="BorderBrush" Value="#388E3C"/>
                                                                        <Setter TargetName="ButtonIcon" Property="Stroke" Value="White"/>
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Button.Template>
                                                    </Button>
                                                </Border>
                                            </StackPanel>
                                        </ScrollViewer>

                                        <!-- å³ä¾§:å›ºå®šçš„æ·»åŠ å·¥ä½œæµæŒ‰é’® - å½“TabItemså¤šæ—¶æ˜¾ç¤º -->
                                        <Border Grid.Column="1" 
                                                x:Name="FixedAddButtonBorder"
                                                Visibility="Collapsed"
                                                Background="#F5F5F5" Padding="2,2,8,0">
                                            <Button Width="40" Height="40"
                                                    Padding="0"
                                                    BorderThickness="1"
                                                    BorderBrush="#4CAF50"
                                                    Background="#F1F8E9"
                                                    Cursor="Hand"
                                                    Click="AddWorkflow_Click">
                                                <Button.Template>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border x:Name="ButtonBorder"
                                                                Background="{TemplateBinding Background}"
                                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                                CornerRadius="6"
                                                                Width="{TemplateBinding Width}"
                                                                Height="{TemplateBinding Height}">
                                                            <Path x:Name="ButtonIcon"
                                                                  Data="M12,6 L12,18 M6,12 L18,12"
                                                                  Stroke="#4CAF50"
                                                                  StrokeThickness="2.5"
                                                                  Fill="Transparent"
                                                                  Stretch="Uniform"
                                                                  Width="20" Height="20"
                                                                  HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="ButtonBorder" Property="Background" Value="#4CAF50"/>
                                                                <Setter TargetName="ButtonBorder" Property="BorderBrush" Value="#388E3C"/>
                                                                <Setter TargetName="ButtonIcon" Property="Stroke" Value="White"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Button.Template>
                                            </Button>
                                        </Border>
                                    </Grid>
                                </Border>

                                <!-- TabContentå†…å®¹åŒºåŸŸ -->
                                <ContentPresenter x:Name="PART_SelectedContentHost"
                                                  Grid.Row="1"
                                                  Margin="0"/>
                            </Grid>
                        </ControlTemplate>
                    </TabControl.Template>

                    <!-- è‡ªå®šä¹‰TabItemå®¹å™¨æ ·å¼ -->
                    <TabControl.ItemContainerStyle>
                        <Style TargetType="TabItem">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="4,2,0,0"/>
                            <Setter Property="Height" Value="40"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabItem">
                                        <Grid>
                                            <Border x:Name="TabBorder"
                                                    Background="#FFFFFF"
                                                    BorderBrush="#E0E0E0"
                                                    BorderThickness="1,1,1,0"
                                                    CornerRadius="6,6,0,0"
                                                    Padding="0"
                                                    Margin="0,0,0,0">
                                                <Grid Margin="8,0">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- å·¥ä½œæµåç§° -->
                                                    <TextBlock Grid.Column="0"
                                                               Text="{Binding Name}"
                                                               FontSize="13"
                                                               FontWeight="SemiBold"
                                                               Foreground="#333333"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,12,0"/>

                                                    <!-- å•æ¬¡è¿è¡ŒæŒ‰é’® - ä»…åœ¨é€‰ä¸­æ—¶æ˜¾ç¤º -->
                                                    <Button x:Name="SingleRunBtn"
                                                            Grid.Column="1"
                                                            Content="â–¶"
                                                            Padding="6,4"
                                                            Margin="0"
                                                            BorderThickness="0"
                                                            FontSize="12"
                                                            Foreground="White"
                                                            Tag="{Binding}"
                                                            Click="TabItem_SingleRun_Click"
                                                            Cursor="Hand"
                                                            Width="32" Height="32"
                                                            Visibility="Collapsed">
                                                        <Button.Background>
                                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                <GradientStop Color="#4CAF50" Offset="0"/>
                                                                <GradientStop Color="#45A049" Offset="1"/>
                                                            </LinearGradientBrush>
                                                        </Button.Background>
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Template">
                                                                    <Setter.Value>
                                                                        <ControlTemplate TargetType="Button">
                                                                            <Border Background="{TemplateBinding Background}"
                                                                                    CornerRadius="6"
                                                                                    Width="{TemplateBinding Width}"
                                                                                    Height="{TemplateBinding Height}">
                                                                                <ContentPresenter Content="{TemplateBinding Content}"
                                                                                                  HorizontalAlignment="Center"
                                                                                                  VerticalAlignment="Center"/>
                                                                            </Border>
                                                                        </ControlTemplate>
                                                                    </Setter.Value>
                                                                </Setter>
                                                                <Style.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Opacity" Value="0.9"/>
                                                                        <Setter Property="Effect">
                                                                            <Setter.Value>
                                                                                <DropShadowEffect Color="#4CAF50" BlurRadius="8" ShadowDepth="0"/>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </Trigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>

                                                    <!-- è¿žç»­è¿è¡Œ/åœæ­¢æŒ‰é’® - ä»…åœ¨é€‰ä¸­æ—¶æ˜¾ç¤º -->
                                                    <Button x:Name="ContinuousRunBtn"
                                                            Grid.Column="2"
                                                            Padding="6,4"
                                                            Margin="6,0,0,0"
                                                            BorderThickness="0"
                                                            Tag="{Binding}"
                                                            Click="TabItem_ContinuousRun_Click"
                                                            Cursor="Hand"
                                                            Width="32" Height="32"
                                                            Visibility="Collapsed">
                                                        <Button.Background>
                                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                <GradientStop Color="{Binding IsRunning, Converter={StaticResource ContinuousRunBackgroundConverter}}" Offset="0"/>
                                                                <GradientStop Color="{Binding IsRunning, Converter={StaticResource ContinuousRunBackgroundConverter}}" Offset="1"/>
                                                            </LinearGradientBrush>
                                                        </Button.Background>
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Template">
                                                                    <Setter.Value>
                                                                        <ControlTemplate TargetType="Button">
                                                                            <Border Background="{TemplateBinding Background}"
                                                                                    CornerRadius="6"
                                                                                    Width="{TemplateBinding Width}"
                                                                                    Height="{TemplateBinding Height}">
                                                                                <Path Data="{Binding IsRunning, Converter={StaticResource ContinuousRunIconTriangleInLoopConverter}}"
                                                                                      Fill="{Binding IsRunning, Converter={StaticResource ContinuousRunIconColorConverter}}"
                                                                                      Stretch="Uniform"
                                                                                      Width="20" Height="20"
                                                                                      HorizontalAlignment="Center"
                                                                                      VerticalAlignment="Center"/>
                                                                            </Border>
                                                                        </ControlTemplate>
                                                                    </Setter.Value>
                                                                </Setter>
                                                                <Style.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Opacity" Value="0.9"/>
                                                                        <Setter Property="Effect">
                                                                            <Setter.Value>
                                                                                <DropShadowEffect BlurRadius="8" ShadowDepth="0"/>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </Trigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>

                                                    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ - ä»…åœ¨é€‰ä¸­æ—¶æ˜¾ç¤º -->
                                                    <Ellipse x:Name="StateIndicator"
                                                             Grid.Column="3"
                                                             Width="12" Height="12"
                                                             Fill="{Binding State, Converter={StaticResource WorkflowStateToColorConverter}}"
                                                             VerticalAlignment="Center"
                                                             Margin="12,0,8,0"
                                                             Visibility="Collapsed">
                                                        <Ellipse.Effect>
                                                            <DropShadowEffect Color="{Binding State, Converter={StaticResource WorkflowStateToColorConverter}}"
                                                                              BlurRadius="6" ShadowDepth="0"/>
                                                        </Ellipse.Effect>
                                                    </Ellipse>

                                                    <!-- åˆ é™¤æŒ‰é’® - ä»…åœ¨é€‰ä¸­æ—¶æ˜¾ç¤º -->
                                                    <Button x:Name="DeleteBtn"
                                                            Grid.Column="4"
                                                            Content="âœ•"
                                                            Padding="0"
                                                            Margin="0"
                                                            Background="Transparent"
                                                            BorderThickness="1"
                                                            BorderBrush="Transparent"
                                                            FontSize="16"
                                                            Foreground="#999999"
                                                            Tag="{Binding}"
                                                            Click="TabItem_Delete_Click"
                                                            Cursor="Hand"
                                                            Width="24" Height="24"
                                                            VerticalAlignment="Center"
                                                            Visibility="Collapsed">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Template">
                                                                    <Setter.Value>
                                                                        <ControlTemplate TargetType="Button">
                                                                            <Border Background="{TemplateBinding Background}"
                                                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                                                    CornerRadius="4"
                                                                                    Width="{TemplateBinding Width}"
                                                                                    Height="{TemplateBinding Height}">
                                                                                <ContentPresenter Content="{TemplateBinding Content}"
                                                                                                  HorizontalAlignment="Center"
                                                                                                  VerticalAlignment="Center"/>
                                                                            </Border>
                                                                        </ControlTemplate>
                                                                    </Setter.Value>
                                                                </Setter>
                                                                <Style.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Background" Value="#FFF5F5"/>
                                                                        <Setter Property="BorderBrush" Value="#FF4444"/>
                                                                        <Setter Property="Foreground" Value="#FF4444"/>
                                                                    </Trigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </Grid>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="TabBorder" Property="Background" Value="#FFFFFF"/>
                                                <Setter TargetName="TabBorder" Property="BorderBrush" Value="#667EEA"/>
                                                <Setter TargetName="TabBorder" Property="BorderThickness" Value="2,2,2,0"/>
                                                <Setter TargetName="TabBorder" Property="Effect">
                                                    <Setter.Value>
                                                        <DropShadowEffect Color="#667EEA" BlurRadius="12" ShadowDepth="0"/>
                                                    </Setter.Value>
                                                </Setter>
                                                <Setter TargetName="SingleRunBtn" Property="Visibility" Value="Visible"/>
                                                <Setter TargetName="ContinuousRunBtn" Property="Visibility" Value="Visible"/>
                                                <Setter TargetName="StateIndicator" Property="Visibility" Value="Visible"/>
                                                <Setter TargetName="DeleteBtn" Property="Visibility" Value="Visible"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="TabBorder" Property="Background" Value="#F8F9FA"/>
                                                <Setter TargetName="TabBorder" Property="BorderBrush" Value="#667EEA"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </TabControl.ItemContainerStyle>

                    <!-- TabItemå†…å®¹ - ç»Ÿä¸€ä½¿ç”¨WorkflowCanvas -->
                    <TabControl.ContentTemplate>
                        <DataTemplate>
                            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto"
                                         PreviewMouseWheel="CanvasScrollViewer_PreviewMouseWheel"
                                         Background="#F5F8FC">
                                <Grid Width="5000" Height="5000" Background="#FFFFFF" DataContext="{Binding RelativeSource={RelativeSource AncestorType=TabItem}, Path=Content}">
                                    <!-- ç”»å¸ƒè¾¹æ¡† -->
                                    <Border BorderBrush="#0066CC" BorderThickness="3" Margin="10" CornerRadius="5">
                                        <Border.Effect>
                                            <DropShadowEffect Color="#0066CC" BlurRadius="15" ShadowDepth="0" Opacity="0.3"/>
                                        </Border.Effect>
                                    </Border>
                                    <!-- ç”»å¸ƒæ ‡é¢˜æ°´å° -->
                                    <TextBlock Text="ðŸ“‹ å·¥ä½œæµç”»å¸ƒ (Workflow Canvas)"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Top"
                                               Margin="0,30,0,0"
                                               FontSize="28"
                                               FontWeight="Bold"
                                               Foreground="#E6F0FF"
                                               IsHitTestVisible="False"
                                               Opacity="0.8"
                                               Panel.ZIndex="-1"/>
                                    <controls:WorkflowCanvasControl
                                        Width="5000" Height="5000"
                                        DataContext="{Binding}"
                                        Loaded="WorkflowCanvasControl_Loaded"/>
                                </Grid>
                            </ScrollViewer>
                        </DataTemplate>
                    </TabControl.ContentTemplate>
                </TabControl>
            </Border>

            <!-- å³ä¾§åˆ†å‰²å™¨ - å·¥ä½œåŒºå’Œå³ä¾§é¢æ¿ä¹‹é—´ -->
            <controls:SplitterWithToggle Grid.Column="3" Width="8" MinWidth="8"
                                         ResizeDirection="Columns"
                                         ToggleDirection="Right"
                                         x:Name="RightPanelSplitter"
                                         ToggleClicked="RightPanelSplitter_ToggleClick"/>

            <!-- ========== å³ä¾§é¢æ¿ ========== -->
            <Border Grid.Column="4" Grid.Row="0" Background="#FFFFFF" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0">
                <Grid x:Name="RightPanelGrid">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="500" MinHeight="40" MaxHeight="1000"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*" MinHeight="40" MaxHeight="1000"/>
                    </Grid.RowDefinitions>

                    <!-- å›¾åƒæ˜¾ç¤ºåŒºåŸŸ - ä½¿ç”¨ImageDisplayControl -->
                    <Border Grid.Row="0" Background="#333333" BorderBrush="#333333" BorderThickness="0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- å›¾åƒåŒºåŸŸæ ‡é¢˜ -->
                            <Border Grid.Row="0" Background="#444444" BorderBrush="#555555" BorderThickness="0,0,0,0" Padding="8,4">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="ðŸ–¼ï¸" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Text="å›¾åƒæ˜¾ç¤º" FontWeight="Bold" FontSize="12" VerticalAlignment="Center" Foreground="White"/>
                                </StackPanel>
                            </Border>

                            <!-- å›¾åƒå†…å®¹ -->
                            <controls:ImageDisplayControl Grid.Row="1"
                                ImageSource="{Binding DisplayImage}"
                                Scale="{Binding ImageScale}"
                                x:Name="ImageDisplayContent"/>
                        </Grid>
                    </Border>

                    <!-- å³ä¾§é¢æ¿å†…éƒ¨åˆ†å‰²å™¨ - å›¾åƒæ˜¾ç¤ºå’Œå±žæ€§é¢æ¿ä¹‹é—´ -->
                    <GridSplitter Grid.Row="1" Height="8" Width="Auto" MinHeight="8"
                                 ResizeDirection="Rows"
                                 Background="#DDDDDD"
                                 ShowsPreview="False"
                                 ResizeBehavior="PreviousAndNext"
                                 HorizontalAlignment="Stretch"/>

                    <!-- å±žæ€§é¢æ¿ - ä½¿ç”¨PropertyPanelControl -->
                    <Border Grid.Row="2" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <!-- å±žæ€§å†…å®¹ -->
                            <controls:PropertyPanelControl
                                PropertyGroups="{Binding PropertyGroups}"
                                LogText="{Binding LogText}"
                                x:Name="PropertyPanelContent"/>
                        </Grid>
                    </Border>
                </Grid>
            </Border>

            <!-- ========== çŠ¶æ€æ  (24px) ========== -->
            <StatusBar Grid.ColumnSpan="5" Grid.Row="1" Height="24" Background="{StaticResource HeaderBrush}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0">
                <StatusBarItem>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="â—" Foreground="#00CC99" FontSize="10" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="{Binding StatusText}" FontSize="11" VerticalAlignment="Center"/>
                    </StackPanel>
                </StatusBarItem>
                <Separator/>
                <StatusBarItem>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="ðŸ“· ç›¸æœº:" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="{Binding CameraStatus}" FontSize="11" Foreground="#00CC99" VerticalAlignment="Center"/>
                    </StackPanel>
                </StatusBarItem>
                <Separator/>
                <StatusBarItem>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="æµç¨‹1:" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="{Binding IsRunning}" FontSize="11" Foreground="#0066CC" VerticalAlignment="Center"/>
                    </StackPanel>
                </StatusBarItem>
                <Separator/>
                <StatusBarItem>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="CPU:" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="45%" FontSize="11" VerticalAlignment="Center"/>
                    </StackPanel>
                </StatusBarItem>
                <Separator/>
                <StatusBarItem HorizontalAlignment="Right">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="FPS:" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="62.5" FontSize="11" FontWeight="Bold" Foreground="#00CC99" VerticalAlignment="Center"/>
                    </StackPanel>
                </StatusBarItem>
            </StatusBar>
        </Grid>
    </DockPanel>
</Window>
