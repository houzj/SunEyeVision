<UserControl x:Class="SunEyeVision.UI.Controls.WorkflowCanvasControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:SunEyeVision.UI.Converters"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="1000">

    <UserControl.Resources>
        <converters:CurrentWorkflowIdConverter x:Key="CurrentWorkflowIdConverter"/>
        <converters:RunModeConverter x:Key="RunModeConverter"/>
        <converters:BoolToContinuousTextConverter x:Key="BoolToContinuousTextConverter"/>
        <converters:BoolToRunningBackgroundConverter x:Key="BoolToRunningBackgroundConverter"/>
        <converters:BoolToRunningBorderConverter x:Key="BoolToRunningBorderConverter"/>
        <converters:RunModeButtonConverter x:Key="RunModeButtonConverter"/>
        <converters:BezierCurveConverter x:Key="BezierCurveConverter" ControlOffset="80"/>
    </UserControl.Resources>

    <DockPanel>
        <!-- å·¥ä½œæµæ ‡ç­¾é¡µæ  -->
        <Border DockPanel.Dock="Top" Background="#F0F0F0" BorderBrush="#D0D0D0" BorderThickness="0,0,0,1" Padding="8,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- å·¥ä½œæµæ ‡ç­¾ -->
                <ScrollViewer Grid.Column="0" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding Workflows, RelativeSource={RelativeSource AncestorType=UserControl}}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Margin="0,0,4,0" 
                                        BorderBrush="#D0D0D0" 
                                        BorderThickness="1" 
                                        CornerRadius="4" 
                                        Padding="12,6"
                                        Cursor="Hand"
                                        MouseLeftButtonUp="WorkflowTab_Click"
                                        Tag="{Binding}">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="#FFFFFF"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Id, Converter={StaticResource CurrentWorkflowIdConverter}, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                                    <Setter Property="Background" Value="#E6F2FF"/>
                                                    <Setter Property="BorderBrush" Value="#0066CC"/>
                                                    <Setter Property="BorderThickness" Value="2"/>
                                                </DataTrigger>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#F0F8FF"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding Name}" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding RunMode, Converter={StaticResource RunModeConverter}}" FontSize="9" Margin="8,0,4,0" VerticalAlignment="Center" Foreground="#666666"/>
                                        <Button Content="Ã—" FontSize="14" Padding="2,0" Margin="4,0,0,0" 
                                                Background="Transparent" BorderThickness="0" 
                                                Foreground="#999999"
                                                Cursor="Hand"
                                                Click="DeleteWorkflow_Click"
                                                Tag="{Binding}"
                                                VerticalAlignment="Center">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Foreground" Value="#FF4444"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- æ“ä½œæŒ‰é’® -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="+" FontSize="16" Padding="8,4" Width="36" Height="28" 
                            Background="#E6F2FF" BorderBrush="#0066CC" BorderThickness="1"
                            ToolTip="æ·»åŠ å·¥ä½œæµ"
                            Click="AddWorkflow_Click"
                            Cursor="Hand"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- æ“ä½œæŒ‰é’®æ  -->
        <Border DockPanel.Dock="Top" Background="#FFFFFF" BorderBrush="#D0D0D0" BorderThickness="0,0,0,1" Padding="8,6">
            <StackPanel Orientation="Horizontal">
                <!-- è¿è¡ŒæŽ§åˆ¶ -->
                <StackPanel Orientation="Horizontal">
                    <Button Content="ðŸ”„ å•æ¬¡" Padding="8,4" Margin="2" 
                            Background="#F0F8FF" BorderBrush="#0066CC" BorderThickness="1"
                            Tag="{Binding CurrentWorkflow, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            Click="RunSingle_Click"
                            Cursor="Hand"/>
                    <Button Content="{Binding CurrentWorkflow.IsRunning, Converter={StaticResource BoolToContinuousTextConverter}, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                            Padding="8,4" Margin="2" 
                            Background="{Binding CurrentWorkflow.IsRunning, Converter={StaticResource BoolToRunningBackgroundConverter}, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            BorderBrush="{Binding CurrentWorkflow.IsRunning, Converter={StaticResource BoolToRunningBorderConverter}, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            BorderThickness="1"
                            Tag="{Binding CurrentWorkflow, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            Click="ToggleContinuous_Click"
                            Cursor="Hand"/>
                </StackPanel>

                <Separator Margin="8,0"/>

                <!-- æ¨¡å¼åˆ‡æ¢ -->
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="æ¨¡å¼:" VerticalAlignment="Center" Margin="4,0" FontSize="12" Foreground="#666666"/>
                    <Button Content="{Binding CurrentWorkflow.RunMode, Converter={StaticResource RunModeButtonConverter}, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                            Padding="8,4" Margin="2" 
                            Background="#F8F8F8" BorderBrush="#CCCCCC" BorderThickness="1"
                            Tag="{Binding CurrentWorkflow, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            Click="ToggleRunMode_Click"
                            Cursor="Hand"/>
                </StackPanel>

                <Separator Margin="8,0"/>

                <!-- å…¶ä»–æ“ä½œ -->
                <Button Content="ðŸ—‘ï¸ æ¸…ç©º" Padding="8,4" Margin="2" 
                        Background="#FFF8F0" BorderBrush="#FF9900" BorderThickness="1"
                        Click="ClearCurrentWorkflow_Click"
                        Cursor="Hand"/>
            </StackPanel>
        </Border>

        <!-- å·¥ä½œæµç”»å¸ƒ -->
        <Border Background="#F5F5F5">
            <Canvas x:Name="WorkflowCanvas" 
                    ClipToBounds="True"
                    DragEnter="WorkflowCanvas_DragEnter"
                    DragOver="WorkflowCanvas_DragOver"
                    DragLeave="WorkflowCanvas_DragLeave"
                    Drop="WorkflowCanvas_Drop">
                
                <!-- ç½‘æ ¼èƒŒæ™¯ -->
                <Canvas.Background>
                    <DrawingBrush ViewportUnits="Absolute" Viewport="0,0,20,20" TileMode="Tile">
                        <DrawingBrush.Drawing>
                            <GeometryDrawing Brush="Transparent">
                                <GeometryDrawing.Pen>
                                    <Pen Brush="#E0E0E0" Thickness="0.5"/>
                                </GeometryDrawing.Pen>
                                <GeometryDrawing.Geometry>
                                    <GeometryGroup>
                                        <LineGeometry StartPoint="0,20" EndPoint="20,20"/>
                                        <LineGeometry StartPoint="20,0" EndPoint="20,20"/>
                                    </GeometryGroup>
                                </GeometryDrawing.Geometry>
                            </GeometryDrawing>
                        </DrawingBrush.Drawing>
                    </DrawingBrush>
                </Canvas.Background>

                <!-- è¿žæŽ¥çº¿ - ä½¿ç”¨è´å¡žå°”æ›²çº¿ -->
                <ItemsControl ItemsSource="{Binding Connections, RelativeSource={RelativeSource AncestorType=UserControl}}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Path Data="{Binding ., Converter={StaticResource BezierCurveConverter}, ConverterParameter={Binding .}}"
                                  Stroke="#666666" StrokeThickness="2" Fill="Transparent"
                                  StrokeLineJoin="Round"
                                  Cursor="Hand">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Stroke" Value="#0066CC"/>
                                                <Setter Property="StrokeThickness" Value="3"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                            </Path>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- èŠ‚ç‚¹ -->
                <ItemsControl ItemsSource="{Binding Nodes, RelativeSource={RelativeSource AncestorType=UserControl}}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Width="140" Height="90"
                                    Background="#FFFFFF"
                                    BorderBrush="#CCCCCC"
                                    BorderThickness="1"
                                    CornerRadius="6"
                                    Canvas.Left="{Binding Position.X}"
                                    Canvas.Top="{Binding Position.Y}"
                                    PreviewMouseLeftButtonDown="Node_PreviewMouseLeftButtonDown"
                                    MouseLeftButtonUp="Node_MouseLeftButtonUp"
                                    MouseMove="Node_MouseMove"
                                    Cursor="Move"
                                    Tag="{Binding}">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="4" ShadowDepth="2" Color="#00000033"/>
                                </Border.Effect>
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="#FFFFFF"/>
                                        <Setter Property="BorderBrush" Value="#CCCCCC"/>
                                        <Setter Property="BorderThickness" Value="1"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                <Setter Property="Background" Value="#E6F2FF"/>
                                                <Setter Property="BorderBrush" Value="#0066CC"/>
                                                <Setter Property="BorderThickness" Value="2"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <Grid>
                                    <!-- èŠ‚ç‚¹æ ‡é¢˜æ  -->
                                    <Border Background="#F0F0F0" CornerRadius="6,6,0,0" Padding="8,6" 
                                            PreviewMouseLeftButtonDown="Node_PreviewMouseLeftButtonDown"
                                            Tag="{Binding}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding Name}" FontSize="11" FontWeight="SemiBold" Foreground="#333333"/>
                                            <Ellipse Grid.Column="1" Width="8" Height="8" Fill="#00CC99" VerticalAlignment="Center" Margin="4,0,0,0"/>
                                        </Grid>
                                    </Border>
                                    <!-- è¿žæŽ¥ç‚¹ - å·¦ä¾§ -->
                                    <Ellipse Width="14" Height="14" Fill="#0066CC" Stroke="#FFFFFF" StrokeThickness="2"
                                             HorizontalAlignment="Left" VerticalAlignment="Center" Margin="-7,0,0,0"
                                             Cursor="Cross"
                                             PreviewMouseLeftButtonDown="Node_ClickForConnection"
                                             Tag="{Binding}"
                                             Panel.ZIndex="10">
                                        <Ellipse.Style>
                                            <Style TargetType="Ellipse">
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Fill" Value="#FF6600"/>
                                                        <Setter Property="Width" Value="16"/>
                                                        <Setter Property="Height" Value="16"/>
                                                        <Setter Property="Margin" Value="-8,0,0,0"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Ellipse.Style>
                                    </Ellipse>
                                    <!-- è¿žæŽ¥ç‚¹ - å³ä¾§ -->
                                    <Ellipse Width="14" Height="14" Fill="#0066CC" Stroke="#FFFFFF" StrokeThickness="2"
                                             HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,-7,0"
                                             Cursor="Cross"
                                             PreviewMouseLeftButtonDown="Node_ClickForConnection"
                                             Tag="{Binding}"
                                             Panel.ZIndex="10">
                                        <Ellipse.Style>
                                            <Style TargetType="Ellipse">
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Fill" Value="#FF6600"/>
                                                        <Setter Property="Width" Value="16"/>
                                                        <Setter Property="Height" Value="16"/>
                                                        <Setter Property="Margin" Value="0,0,-8,0"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Ellipse.Style>
                                    </Ellipse>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Canvas>
        </Border>
    </DockPanel>
</UserControl>
